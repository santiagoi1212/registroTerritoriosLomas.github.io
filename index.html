<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa · Realizar + Registros + Sync (1 archivo, sin descarga ni bordes por territorio)</title>

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .label { font-weight: bold; font-size: 12px; color: black; text-shadow: 1px 1px 2px white; }
    #status {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 4px; font-size: 14px;
    }
    #btn-registros {
      position: absolute; top: 12px; right: 12px; z-index: 1000;
      background: #0b5; color: #071; border: none; border-radius: 10px;
      padding: 10px 12px; font-weight: 800; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,.25);
    }

    #overlay { position: absolute; inset: 0; background: rgba(0,0,0,.4);
      display: none; align-items: center; justify-content: center; z-index: 1100; }
    #panel {
      background: #fff; color: #222; width: min(1000px, 96vw); max-height: 88vh;
      border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,.35); display: flex; flex-direction: column;
    }
    #panel header { padding: 12px 16px; border-bottom: 1px solid #e6e6e6; display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    #panel header h3 { margin: 0; font-size: 16px; }
    #panel .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    #panel .actions button { border: 1px solid #ddd; background: #f5f5f5; border-radius: 8px; padding: 8px 10px; cursor: pointer; font-weight: 600; }
    #panel .actions button.primary { background: #0b74ff; color: white; border-color: #0b74ff; }
    #panel .actions button.warn    { background: #fff3cd; border-color: #ffecb5; color: #8a6d3b; }
    #panel .actions button.danger  { background: #e53935; color: white; border-color: #e53935; }
    #panel .content { padding: 12px 16px; overflow: auto; }

    .filters {
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto auto;
      gap: 8px; margin-bottom: 10px; align-items: end;
    }
    .filters label { display:block; font-size: 12px; color: #555; margin-bottom: 4px; }
    .filters input, .filters select { padding: 7px 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 13px; }
    .filters button { border: 1px solid #ddd; background: #f0f0f0; border-radius: 8px; padding: 8px 10px; cursor: pointer; font-weight: 600; }

    #tbl { border-collapse: collapse; width: 100%; font-size: 13px; }
    #tbl th, #tbl td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align: left; }
    #tbl th { position: sticky; top: 0; background: #fafafa; z-index: 1; }
    .muted { color:#666; font-size:12px; }

    .form-realizar { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 13px; min-width: 240px; }
    .form-realizar .row { margin-bottom: 8px; }
    .form-realizar label { display:block; margin-bottom:4px; color:#333; font-weight:600; }
    .form-realizar input, .form-realizar select { width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:6px; font-size:13px; }
    .form-realizar .actions { display:flex; gap:8px; justify-content:flex-end; }
    .form-realizar button { padding:7px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
    .btn-guardar { background:#2e7d32; color:#fff; }
    .btn-cancelar { background:#ddd; color:#333; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status"></div>

  <button id="btn-registros" title="Ver y exportar registros locales">Registros</button>

  <div id="overlay" role="dialog" aria-modal="true">
    <div id="panel">
      <header>
        <h3>Registros locales de “Realizar territorio”</h3>
        <div class="actions">
          <button id="btn-sync" class="primary" title="Enviar pendientes al Spreadsheet">Sincronizar (0)</button>
          <button id="btn-exp-json">Exportar JSON (filtrado)</button>
          <button id="btn-exp-csv" class="warn">Exportar CSV (filtrado)</button>
          <button id="btn-borrar-todo" class="danger">Borrar todo</button>
          <button id="btn-cerrar">Cerrar</button>
        </div>
      </header>
      <div class="content">
        <div class="filters">
          <div>
            <label for="filter-days">Rango</label>
            <select id="filter-days">
              <option value="30" selected>Últimos 30 días</option>
              <option value="7">Últimos 7 días</option>
              <option value="90">Últimos 90 días</option>
              <option value="365">Últimos 365 días</option>
              <option value="all">Todos</option>
            </select>
          </div>
          <div>
            <label for="filter-id">Buscar por ID</label>
            <input id="filter-id" placeholder="Ej: 12" />
          </div>
          <div>
            <label for="filter-cap">Capitán</label>
            <input id="filter-cap" placeholder="Ej: Ana" />
          </div>
          <div>
            <label for="filter-estado">Estado</label>
            <select id="filter-estado">
              <option value="all" selected>Todos</option>
              <option value="Si">Si</option>
              <option value="No">No</option>
            </select>
          </div>
          <div><button id="btn-aplicar">Aplicar</button></div>
          <div><button id="btn-limpiar">Limpiar filtros</button></div>
        </div>

        <div id="resumen" class="muted" style="margin-bottom:8px"></div>
        <table id="tbl">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>ID</th>
              <th>Capitán</th>
              <th>Territorio</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// ================= CONFIG =================
const MAP_CENTER = [-34.777651, -55.855565];
const MAP_ZOOM   = 17;

// Lectura de Sheets
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnjPtaFTh49d_U3mD8kNr6_YoXZoUL5d5Ah11E2FcAMjrHtSyJkH6Q6p0seJyp3JOa6iK2F8ODpxrf/pub?gid=0&single=true&output=csv"
const SHEET_ID  = "1PGMF6givdrByw3pm0KsVabDEz-fOVlSxDhyQa4mMIAQ";
const SHEET_GID = "0";
const GVIZ_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

// Escritura (Apps Script Web App /exec)
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbweVDu_2Vn0ygEMQdkgqbVprTKJ2kjAT--Wimo0cVTaASLK3-yJMkt175DJq-pky1Y/exec";

// LocalStorage keys
const LS_REAL  = "realizaciones_lomas";
const LS_QUEUE = "realizaciones_queue_pend";

const REFRESH_MS = 5 * 60 * 1000;
let refreshTimer = null;

// Leaflet
const map  = L.map("map").setView(MAP_CENTER, MAP_ZOOM);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
const capa = L.featureGroup().addTo(map);

(function sanity() {
  if (!/^https:\/\/script\.google\.com\/macros\/.+\/exec$/.test(WEBHOOK_URL)) {
    console.warn("WEBHOOK_URL no parece un Apps Script /exec. Editá el HTML y pegá la URL correcta.");
  }
})();

function setStatus(msg) {
  const el = document.getElementById("status");
  el.textContent = msg || "";
  if (!msg) return;
  clearTimeout(setStatus._t);
  setStatus._t = setTimeout(() => el.textContent = "", 4000);
}

function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => {
    refreshFromSheet().catch(err => console.warn('Auto-refresh error:', err));
  }, REFRESH_MS);
}

function estiloPorEstado(estado) {
  // Borde fino, relleno por estado (sin color por territorio)
  const base = { color: "#333", weight: 1, fillOpacity: 0.30 };
  if (!estado) return { ...base, fillColor: "#90caf9" };
  const s = String(estado).toLowerCase();
  if (s.includes("blue"))   return { ...base, fillColor: "#3388ff" };
  if (s.includes("green"))  return { ...base, fillColor: "#2e7d32" };
  if (s.includes("yellow")) return { ...base, fillColor: "#ffd500" };
  if (s.includes("red"))    return { ...base, fillColor: "#b53a22" };
  return { ...base, fillColor: "#90caf9" };
}
function diferenciaEnMeses(a, b) {
  if (!(a instanceof Date) || isNaN(a)) return Infinity;
  let meses = (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
  if (b.getDate() < a.getDate()) meses -= 1;
  return meses;
}
function parseCSVLine(line) {
  const out = []; let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQ && line[i+1] === '"') { cur += '"'; i++; }
      else { inQ = !inQ; }
    } else if (ch === ',' && !inQ) { out.push(cur); cur = ''; }
    else cur += ch;
  }
  out.push(cur);
  return out;
}
function parseFechaSeguro(s) {
  s = String(s || '').trim();
  if (!s) return new Date('Invalid');
  const d1 = new Date(s);
  if (!isNaN(d1)) return d1;
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  return new Date('Invalid');
}
function normalizarFinalizado(v) {
  const s = String(v ?? '').trim().toLowerCase();
  if (!s) return '';
  if (['si','sí','s','true','1','ok','finalizado','completo','terminado'].includes(s)) return 'Si';
  if (['no','n','false','0','pendiente','incompleto','en curso','trabajando'].includes(s)) return 'No';
  return s;
}
function leerRealizacionesLS() {
  try { const raw = localStorage.getItem(LS_REAL); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; }
  catch { return []; }
}
function guardarRealizacionLS(rec) {
  const arr = leerRealizacionesLS();
  const i = arr.findIndex(x => String(x.id) === String(rec.id));
  if (i >= 0) arr[i] = rec; else arr.push(rec);
  localStorage.setItem(LS_REAL, JSON.stringify(arr));
}
function queueGet() { try { const raw = localStorage.getItem(LS_QUEUE); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; } catch { return []; } }
function queueSet(arr) { localStorage.setItem(LS_QUEUE, JSON.stringify(arr)); }
function queueAdd(rec) { const arr = queueGet(); arr.push(rec); queueSet(arr); updateSyncBadge(); }
function queueRemoveAt(idx) { const arr = queueGet(); arr.splice(idx,1); queueSet(arr); updateSyncBadge(); }
function byId(arr) { const m = new Map(); (arr||[]).forEach(x => m.set(String(x.id), x)); return m; }

function territorioDef(p) { return (p.territorio ?? p.territorioStr ?? p.id); }
function fmtDateInput(d) {
  if (!(d instanceof Date) || isNaN(d)) d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// ===== Lectura del Sheet =====
async function fetchCSV(url) {
  if (!url) throw new Error("csv-url-empty");
  const r = await fetch(url, { headers: { 'Accept': 'text/csv' }, cache: 'no-cache' });
  if (!r.ok) throw new Error('csv-http-'+r.status);
  return await r.text();
}
async function cargarDatosDesdeSheets() {
  if (SHEET_CSV) {
    try {
      const csv = await fetchCSV(SHEET_CSV);
      return parseCSVToRows(csv);
    } catch (e) {
      console.warn('CSV publicado no disponible:', e.message || e);
    }
  }
  try {
    const txt = await fetch(GVIZ_URL, { cache: 'no-cache' }).then(r => r.text());
    const json = JSON.parse(txt.replace(/^[^{}]+/, '').replace(/\);?\s*$/, ''));
    return gvizToRows(json);
  } catch (e) {
    console.error('GVIZ tampoco disponible:', e);
    return [];
  }
}
function parseCSVToRows(csv) {
  const lines = csv.split(/\r?\n/).filter(l => l.trim() !== '');
  if (!lines.length) return [];
  const header = parseCSVLine(lines[0]).map(h => String(h).trim().toLowerCase());
  const idx = (names) => names.map(n => header.indexOf(n)).find(i => i >= 0);
  const iId    = idx(['id']);
  const iFecha = idx(['fecha','date']);
  const iFin   = idx(['finalizado','fin','estado','status']);
  const out = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    const id = iId != null ? cols[iId] : cols[0];
    if (id == null || String(id).trim() === '') continue;
    const rawFecha = iFecha != null ? cols[iFecha] : '';
    const rawFin   = iFin != null ? cols[iFin]   : '';
    out.push({
      id: parseInt(String(id).trim(),10),
      fecha: parseFechaSeguro(rawFecha || ''),
      finalizado: normalizarFinalizado(rawFin || '')
    });
  }
  return out;
}
function gvizToRows(json) {
  const cols = (json.table && json.table.cols) ? json.table.cols : [];
  const rows = (json.table && json.table.rows) ? json.table.rows : [];
  const labels = cols.map(c => String((c && (c.label || c.id)) || '').trim().toLowerCase());
  const idx = (names) =>
    names.map(n => labels.indexOf(n))
         .find(i => i >= 0);
  const iId    = idx(['id']);
  const iFecha = idx(['fecha','date']);
  const iFin   = idx(['finalizado','estado','fin']);
  const out = [];
  for (const r of rows) {
    const c = (r && r.c) || [];
    const get = (i) => (i != null && i >= 0 && c[i] && c[i].v != null) ? c[i].v : '';
    const idVal = get(iId);
    if (idVal === '') continue;
    out.push({
      id: parseInt(String(idVal).trim(),10),
      fecha: parseFechaSeguro(get(iFecha)),
      finalizado: normalizarFinalizado(get(iFin))
    });
  }
  return out;
}
function mergeSheets(poligonos, datosSheets) {
  const m = byId(datosSheets);
  return (poligonos||[]).map(p => { const d = m.get(String(p.id)); if (d) { p.fecha = d.fecha; p.finalizado = d.finalizado; } return p; });
}
function mergeRealizacionesLocales(poligonos) {
  const regs = byId(leerRealizacionesLS());
  return (poligonos||[]).map(p => {
    const r = regs.get(String(p.id));
    if (r) {
      p.fecha = new Date(r.fecha);
      p.finalizado = normalizarFinalizado(r.estado);
      p.capitan = r.capitan || '';
      p.territorioStr = r.territorio || '';
    }
    return p;
  });
}

// ===== Escritura Sheet (POST → fallback GET) =====
async function enviarAlSheet(rec) {
  try {
    const body = new URLSearchParams({ payload: JSON.stringify(rec) });
    const r = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
      body
    });
    const text = await r.text().catch(()=> "");
    if (r.ok && /"ok"\s*:\s*true/.test(text)) return { ok: true, via: 'POST' };
    if (r.status === 405) throw new Error("405");
    throw new Error(text || ("HTTP " + r.status));
  } catch (err) {
    try {
      const url = WEBHOOK_URL + "?" + new URLSearchParams({ payload: JSON.stringify(rec) });
      await fetch(url, { method: "GET", mode: "no-cors" });
      return { ok: true, via: 'GET-no-cors' };
    } catch (e2) {
      console.warn("Fallo envío, guardando en cola:", e2);
      queueAdd(rec);
      return { ok:false, queued:true, reason:String(e2) };
    }
  }
}

// ===== Form por polígono (sin editar territorio; con fecha) =====
function formHTML(id, valores = {}) {
  const { capitan='', estado='Si', fechaValida = new Date() } = valores;
  const fechaInput = fmtDateInput(fechaValida);
  return `
    <div class="form-realizar">
      <div class="row">
        <label for="cap-${id}">Capitán</label>
        <input id="cap-${id}" value="${capitan || ''}" placeholder="Nombre del capitán"/>
      </div>
      <div class="row">
        <label for="fec-${id}">Fecha</label>
        <input id="fec-${id}" type="date" value="${fechaInput}" />
      </div>
      <div class="row">
        <label for="est-${id}">Estado</label>
        <select id="est-${id}">
          <option ${estado==='Si'?'selected':''} value="Si">Finalizado (Si)</option>
          <option ${estado==='No'?'selected':''} value="No">No finalizado (No)</option>
        </select>
      </div>
      <div class="muted">Se registra la fecha seleccionada y se sincroniza con el Spreadsheet.</div>
      <div class="actions" style="margin-top:8px">
        <button class="btn-cancelar" id="cancel-${id}">Cancelar</button>
        <button class="btn-guardar" id="save-${id}">Guardar</button>
      </div>
    </div>`;
}
function attachFormHandlers(poly, p) {
  const id = p.id;
  const btnSave = document.getElementById(`save-${id}`);
  const btnCancel = document.getElementById(`cancel-${id}`);
  if (btnCancel) btnCancel.onclick = () => poly.closePopup();
  if (!btnSave) return;

  btnSave.onclick = async () => {
    const cap = (document.getElementById(`cap-${id}`)?.value || '').trim();
    const est = (document.getElementById(`est-${id}`)?.value || 'Si');
    const dateStr = (document.getElementById(`fec-${id}`)?.value || '').trim(); // YYYY-MM-DD
    let fechaISO;
    if (dateStr) {
      const dt = new Date(dateStr + 'T00:00:00');
      fechaISO = dt.toISOString();
    } else {
      fechaISO = new Date().toISOString();
    }

    const terDef = String(territorioDef(p));
    const rec = { id, capitan: cap, territorio: terDef, estado: est, fecha: fechaISO, origen: navigator.userAgent || '' };

    guardarRealizacionLS(rec);
    p.capitan = cap;
    p.territorioStr = terDef;
    p.finalizado = normalizarFinalizado(est);
    p.fecha = new Date(fechaISO);

    const fechaValida = p.fecha instanceof Date && !isNaN(p.fecha);
    const diffMeses = fechaValida ? diferenciaEnMeses(p.fecha, new Date()) : Infinity;
    let color = 'red';
    if (diffMeses < 2) color = p.finalizado === 'Si' ? 'green' : 'blue';
    else if (diffMeses <= 3) color = 'yellow';
    poly.setStyle(estiloPorEstado(color));

    const fechaHtml = fechaValida ? 'Fecha: ' + fmtDateInput(p.fecha) + '<br/>' : '';
    const capHtml   = p.capitan ? ('Capitán: ' + p.capitan + '<br/>') : '';
    const terHtml   = p.territorioStr ? ('Territorio: ' + p.territorioStr + '<br/>') : '';
    poly.setPopupContent(
      `<b>Territorio ${p.id}</b><br/>${fechaHtml}${capHtml}${terHtml}Estado: ${p.finalizado || 'Desconocido'}<hr/>`
      + formHTML(id, { capitan: p.capitan, estado: p.finalizado || 'Si', fechaValida: p.fecha })
    );
    attachFormHandlers(poly, p);

    const res = await enviarAlSheet(rec);
    if (res.ok) setStatus(`Guardado y sincronizado (ID ${id}) via ${res.via}.`);
    else setStatus(`Guardado local. Pendiente de Sync (ID ${id}).`);
    updateSyncBadge();
  };
}

// ===== Pintar polígonos (sin bordes por territorio) =====
function pintar(poligonos) {
  capa.clearLayers();
  (poligonos || []).forEach(p => {
    if (!p || !Array.isArray(p.coords) || p.coords.length < 3) return;
    try {
      const fechaValida = p.fecha instanceof Date && !isNaN(p.fecha);
      const fechaHtml = fechaValida ? 'Fecha: ' + fmtDateInput(p.fecha) + '<br/>' : '';
      let colorEstado = 'red';
      const diffMeses = fechaValida ? diferenciaEnMeses(p.fecha, new Date()) : Infinity;
      if (diffMeses < 2) colorEstado = p.finalizado === 'Si' ? 'green' : 'blue';
      else if (diffMeses <= 3) colorEstado = 'yellow';

      const terTxt = String(p.numeroTerritorio ?? territorioDef(p));
      p.territorioStr = p.territorioStr || terTxt;

      const estilo = estiloPorEstado(colorEstado); // borde fino + relleno por estado
      const poly = L.polygon(p.coords, estilo);
      if (p.id != null) poly.bindTooltip('ID: ' + p.id, { permanent: true, direction: 'center', className: 'label' });

      const capHtml = p.capitan ? ('Capitán: ' + p.capitan + '<br/>') : '';
      const terHtml = p.territorioStr ? ('Territorio: ' + p.territorioStr + '<br/>') : '';
      const content = `<b>Territorio ${p.id ?? ''}</b><br/>${fechaHtml}${capHtml}${terHtml}Estado: ${p.finalizado || 'Desconocido'}<hr/>`
                    + formHTML(p.id, { capitan: p.capitan, estado: p.finalizado || 'Si', fechaValida: p.fecha });
      poly.bindPopup(content, { minWidth: 260 });
      poly.on("popupopen", () => attachFormHandlers(poly, p));
      poly.on("mouseover", () => poly.setStyle({ weight: 2 }));
      poly.on("mouseout",  () => poly.setStyle({ weight: 1 }));
      capa.addLayer(poly);
    } catch (e) { console.warn('Polígono inválido', p, e); }
  });
  if (capa.getLayers().length) map.fitBounds(capa.getBounds(), { padding: [20,20] });
  setStatus('Cargados ' + capa.getLayers().length + ' polígonos.');
}

// ====== Panel de registros ======
const btnReg   = document.getElementById('btn-registros');
const overlay  = document.getElementById('overlay');
const tbody    = document.getElementById('tbody');
const resumen  = document.getElementById('resumen');
const btnSync  = document.getElementById('btn-sync');

let filterDays = 30, filterId = "", filterCapitan = "", filterEstado = "all";
function updateSyncBadge() {
  const n = queueGet().length;
  btnSync.textContent = `Sincronizar (${n})`;
  btnSync.title = n ? `${n} pendiente(s) para enviar al Spreadsheet` : 'No hay pendientes';
}
function openPanel() {
  document.getElementById('filter-days').value = String(filterDays === 'all' ? 'all' : filterDays);
  document.getElementById('filter-id').value   = filterId;
  document.getElementById('filter-cap').value  = filterCapitan;
  document.getElementById('filter-estado').value = filterEstado;
  renderRegistros(); updateSyncBadge(); overlay.style.display = 'flex';
}
function closePanel() { overlay.style.display = 'none'; }
function getFilteredRecords() {
  const data = leerRealizacionesLS().slice().sort((a,b) => (b.fecha||'').localeCompare(a.fecha||''));
  const now = Date.now();
  const days = filterDays === 'all' ? 'all' : Number(filterDays);
  const idq  = (filterId || '').trim();
  const capq = (filterCapitan || '').trim().toLowerCase();
  const estq = (filterEstado || 'all');
  return data.filter(r => {
    if (days !== 'all') {
      const t = r.fecha ? new Date(r.fecha).getTime() : NaN;
      if (isNaN(t)) return false;
      if (now - t > days*24*60*60*1000) return false;
    }
    if (idq && String(r.id) !== idq) return false;
    if (capq) {
      const val = String(r.capitan || '').toLowerCase();
      if (!val.includes(capq)) return false;
    }
    if (estq !== 'all') {
      const val = String(r.estado || '').toLowerCase();
      if (estq.toLowerCase() !== val) return false;
    }
    return true;
  });
}
function renderRegistros() {
  const data = getFilteredRecords();
  tbody.innerHTML = '';
  if (!data.length) { resumen.textContent = 'No hay registros para el filtro seleccionado.'; return; }
  const rangeTxt = filterDays === 'all' ? 'Todos' : `Últimos ${filterDays} día(s)`;
  const idTxt  = filterId      ? ` | ID=${filterId}` : '';
  const capTxt = filterCapitan ? ` | Capitán~"${filterCapitan}"` : '';
  const estTxt = filterEstado !== 'all' ? ` | Estado=${filterEstado}` : '';
  resumen.textContent = `Total: ${data.length} registro(s). Filtro: ${rangeTxt}${idTxt}${capTxt}${estTxt}`;
  for (const r of data) {
    const tr = document.createElement('tr');
    const f = r.fecha ? new Date(r.fecha) : null;
    const ftxt = (f && !isNaN(f)) ? fmtDateInput(f) : '—';
    tr.innerHTML = `<td>${ftxt}</td><td>${r.id ?? ''}</td><td>${(r.capitan ?? '').replace(/</g,'&lt;')}</td><td>${(r.territorio ?? '').replace(/</g,'&lt;')}</td><td>${r.estado ?? ''}</td>`;
    tbody.appendChild(tr);
  }
}
btnReg.addEventListener('click', openPanel);
document.getElementById('btn-cerrar').addEventListener('click', closePanel);
overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closePanel(); });
document.getElementById('btn-aplicar').addEventListener('click', () => {
  const v = document.getElementById('filter-days').value;
  filterDays=(v==='all'?'all':Number(v));
  filterId=(document.getElementById('filter-id').value||'').trim();
  filterCapitan=(document.getElementById('filter-cap').value||'').trim();
  filterEstado=document.getElementById('filter-estado').value||'all';
  renderRegistros();
});
document.getElementById('btn-limpiar').addEventListener('click', () => {
  filterDays=30; filterId=""; filterCapitan=""; filterEstado="all";
  document.getElementById('filter-days').value="30";
  document.getElementById('filter-id').value="";
  document.getElementById('filter-cap').value="";
  document.getElementById('filter-estado').value="all";
  renderRegistros();
});
document.getElementById('btn-exp-json').addEventListener('click', () => {
  const data = getFilteredRecords();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='realizaciones_locales_filtrado.json';
  document.body.appendChild(a); a.click(); a.remove();
});
document.getElementById('btn-exp-csv').addEventListener('click', () => {
  const data = getFilteredRecords();
  const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
  const rows = [['fecha','id','capitan','territorio','estado']];
  for (const r of data) rows.push([r.fecha || '', r.id || '', r.capitan || '', r.territorio || '', r.estado || '']);
  const csv = rows.map(row => row.map(esc).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='realizaciones_locales_filtrado.csv';
  document.body.appendChild(a); a.click(); a.remove();
});
document.getElementById('btn-borrar-todo').addEventListener('click', () => {
  if (!confirm('¿Seguro que querés borrar TODOS los registros locales?')) return;
  localStorage.removeItem(LS_REAL);
  renderRegistros();
  setStatus('Registros locales borrados.');
});
btnSync.addEventListener('click', async () => {
  const arr = queueGet(); if (!arr.length) { setStatus("No hay pendientes para sincronizar."); updateSyncBadge(); return; }
  setStatus("Sincronizando pendientes ("+arr.length+")...");
  for (let i=0; i<arr.length; i++) {
    const rec = arr[i];
    try {
      const res = await enviarAlSheet(rec);
      if (res.ok) { queueRemoveAt(i); i--; }
    } catch (e) { console.warn("Error en sync de un registro:", e); }
  }
  setStatus("Sincronización terminada. Pendientes: "+queueGet().length);
  updateSyncBadge();
});
updateSyncBadge();

// ======== Polígonos embebidos (no se hace fetch) ========
const POLIGONOS_EMBEBIDOS = [{"id": "1601", "territorio": "2", "coords": [[-34.80421, -55.946395], [-34.805109, -55.944539], [-34.806651, -55.945891], [-34.805567, -55.947554]]}, {"id": "1600", "territorio": "2", "coords": [[-34.805673, -55.947651], [-34.806747, -55.945956], [-34.807575, -55.946771], [-34.806589, -55.948294], [-34.806448, -55.948348]]}, {"id": "10108", "territorio": "2", "coords": [[-34.805593, -55.944732], [-34.805171, -55.944378], [-34.806016, -55.942458], [-34.806624, -55.943048]]}, {"id": "10107", "territorio": 2, "coords": [[-34.80569, -55.944808], [-34.806721, -55.943145], [-34.80717, -55.943542], [-34.806175, -55.945215]]}, {"id": "10106", "territorio": "2", "coords": [[-34.806783, -55.944443], [-34.807258, -55.943627], [-34.807787, -55.94411], [-34.807302, -55.944915]]}, {"id": "10105", "territorio": "2", "coords": [[-34.807399, -55.944979], [-34.807884, -55.944175], [-34.80843, -55.944657], [-34.807919, -55.945483]]}, {"id": "1055", "territorio": "2", "coords": [[-34.806078, -55.942361], [-34.806571, -55.94116], [-34.807355, -55.941889], [-34.806712, -55.942941]]}, {"id": "10100", "territorio": "2", "coords": [[-34.80725, -55.943434], [-34.8068, -55.943037], [-34.807452, -55.941954], [-34.807893, -55.942426]]}, {"id": "10101", "territorio": "2", "coords": [[-34.807884, -55.943981], [-34.807346, -55.94352], [-34.807945, -55.942469], [-34.8085, -55.942984]]}, {"id": "10102", "territorio": "2", "coords": [[-34.807972, -55.944078], [-34.808589, -55.943027], [-34.809135, -55.943531], [-34.808492, -55.944561]]}, {"id": "10104", "territorio": "2", "coords": [[-34.80747, -55.946438], [-34.808095, -55.94543], [-34.80858, -55.946213], [-34.808086, -55.947093], [-34.807937, -55.946889]]}, {"id": "1007|142", "territorio": "2", "coords": [[-34.808157, -55.945344], [-34.809214, -55.943584], [-34.809549, -55.943896], [-34.810077, -55.943091], [-34.810289, -55.943531], [-34.808668, -55.946127]]}, {"id": "1005|141", "territorio": "2", "coords": [[-34.810368, -55.943391], [-34.810121, -55.943027], [-34.81139, -55.940945], [-34.811099, -55.940409], [-34.811513, -55.93998], [-34.811945, -55.940816]]}, {"id": "998|135", "territorio": "2", "coords": [[-34.808725, -55.946234], [-34.809236, -55.945408], [-34.810183, -55.94712], [-34.809712, -55.947951]]}, {"id": "999|136", "territorio": "2", "coords": [[-34.810236, -55.947055], [-34.809328, -55.945483], [-34.810117, -55.945113], [-34.810733, -55.946224]]}, {"id": "1001|137", "territorio": "2", "coords": [[-34.810143, -55.945027], [-34.809848, -55.944432], [-34.81035, -55.943574], [-34.811174, -55.945113], [-34.811011, -55.945054], [-34.810733, -55.944985], [-34.81054, -55.944974], [-34.810324, -55.94499]]}, {"id": "1002|138", "territorio": "2", "coords": [[-34.811359, -55.945247], [-34.811284, -55.945183], [-34.81039, -55.943536], [-34.810905, -55.942694], [-34.81187, -55.944448]]}, {"id": "1003|139", "territorio": "2", "coords": [[-34.811909, -55.944394], [-34.810949, -55.942635], [-34.811487, -55.941787], [-34.812429, -55.943531]]}, {"id": "1004|140", "territorio": "2", "coords": [[-34.812482, -55.943472], [-34.811522, -55.941739], [-34.812033, -55.940892], [-34.813019, -55.942667]]}, {"id": "993|134", "territorio": "2", "coords": [[-34.813742, -55.945939], [-34.812482, -55.943606], [-34.811954, -55.944459], [-34.812782, -55.945945], [-34.812896, -55.946063], [-34.813204, -55.946149], [-34.813451, -55.946154]]}, {"id": "1004|140", "territorio": "2", "coords": [[-34.814482, -55.945349], [-34.81305, -55.942737], [-34.812522, -55.943531], [-34.81379, -55.945902]]}, {"id": "985|127", "territorio": "1", "coords": [[-34.810183, -55.948895], [-34.811315, -55.951036], [-34.812077, -55.950521], [-34.810883, -55.948321]]}, {"id": "986|128", "territorio": "1", "coords": [[-34.812121, -55.950483], [-34.810932, -55.948294], [-34.811575, -55.947779], [-34.812671, -55.949721], [-34.812504, -55.95022]]}, {"id": "987|129", "territorio": "1", "coords": [[-34.811628, -55.947742], [-34.812345, -55.947168], [-34.8129, -55.948187], [-34.812896, -55.94882], [-34.812799, -55.949416], [-34.812702, -55.949652]]}, {"id": "989|130", "territorio": "2", "coords": [[-34.813565, -55.949276], [-34.812949, -55.948144], [-34.812989, -55.947586], [-34.813081, -55.947055], [-34.813165, -55.946766], [-34.814231, -55.948734]]}, {"id": "990|131", "territorio": "1", "coords": [[-34.814275, -55.948697], [-34.813196, -55.946712], [-34.813477, -55.946224], [-34.81379, -55.945988], [-34.814966, -55.948139]]}, {"id": "991|132", "territorio": "1", "coords": [[-34.813834, -55.945972], [-34.814521, -55.945414], [-34.815702, -55.947538], [-34.815019, -55.948091]]}, {"id": "978|121", "territorio": "1", "coords": [[-34.815737, -55.947597], [-34.81505, -55.948155], [-34.816208, -55.950285], [-34.816952, -55.949721]]}, {"id": "979|122", "territorio": "1", "coords": [[-34.81501, -55.948192], [-34.81616, -55.950328], [-34.8159, -55.950488], [-34.815644, -55.950601], [-34.815376, -55.950682], [-34.814319, -55.948756]]}, {"id": "980|123", "territorio": "1", "coords": [[-34.813596, -55.949324], [-34.81427, -55.948777], [-34.815318, -55.950692], [-34.815054, -55.950703], [-34.814706, -55.950639], [-34.814213, -55.950456]]}, {"id": "977|120", "territorio": "1", "coords": [[-34.818133, -55.95191], [-34.816966, -55.94978], [-34.816243, -55.950349], [-34.817437, -55.952457]]}, {"id": "1111|119", "territorio": "1", "coords": [[-34.81619, -55.950376], [-34.816058, -55.950483], [-34.815666, -55.951154], [-34.816697, -55.953037], [-34.817379, -55.952495]]}, {"id": "1110|118", "territorio": "1", "coords": [[-34.816657, -55.953074], [-34.815627, -55.951213], [-34.815481, -55.951647], [-34.815415, -55.951942], [-34.815376, -55.95257], [-34.815948, -55.953653]]}, {"id": "1109|117", "territorio": "1", "coords": [[-34.815089, -55.954008], [-34.815248, -55.953573], [-34.815323, -55.953042], [-34.815318, -55.952586], [-34.814737, -55.951588], [-34.814032, -55.952135]]}, {"id": "984|124", "territorio": "1", "coords": [[-34.814711, -55.951518], [-34.814006, -55.952087], [-34.813015, -55.950156], [-34.813363, -55.95014], [-34.813786, -55.950242], [-34.814129, -55.950456]]}, {"id": "1108|116", "territorio": "1", "coords": [[-34.815147, -55.95427], [-34.814724, -55.953482], [-34.813984, -55.952168], [-34.813323, -55.952715], [-34.814451, -55.954823]]}, {"id": "1107|115", "territorio": "1", "coords": [[-34.814407, -55.95486], [-34.813279, -55.952752], [-34.812583, -55.953299], [-34.813755, -55.955418]]}, {"id": "983|125", "territorio": "1", "coords": [[-34.813957, -55.952119], [-34.812944, -55.950161], [-34.812645, -55.95022], [-34.812522, -55.950263], [-34.812156, -55.950542], [-34.813292, -55.952656]]}, {"id": "984|126", "territorio": "1", "coords": [[-34.81324, -55.952688], [-34.812094, -55.950574], [-34.811363, -55.951084], [-34.812548, -55.953246]]}, {"id": "705|6 301", "territorio": "3", "coords": [[-34.81693, -55.948455], [-34.818921, -55.946782], [-34.818472, -55.945902], [-34.817609, -55.946567], [-34.817247, -55.946739], [-34.816719, -55.946867], [-34.81656, -55.947715]]}, {"id": "723|22 318", "territorio": "3", "coords": [[-34.819018, -55.946707], [-34.81856, -55.945837], [-34.819766, -55.944872], [-34.820621, -55.943949], [-34.821264, -55.943263], [-34.822083, -55.944217]]}, {"id": "317", "territorio": "3", "coords": [[-34.818525, -55.945698], [-34.818357, -55.945022], [-34.81834, -55.944518], [-34.818754, -55.944239], [-34.8193, -55.943638], [-34.819855, -55.942941], [-34.82026, -55.942512], [-34.820647, -55.942211], [-34.820815, -55.942662], [-34.821176, -55.943198], [-34.82011, -55.944335], [-34.819405, -55.945022]]}, {"id": "302", "territorio": "3", "coords": [[-34.816736, -55.946717], [-34.817344, -55.946578], [-34.817996, -55.946138], [-34.818436, -55.945795], [-34.818243, -55.944979], [-34.818199, -55.944099], [-34.818234, -55.941954], [-34.817626, -55.942919], [-34.817265, -55.943896], [-34.816939, -55.945483]]}, {"id": "315", "territorio": "3", "coords": [[-34.818322, -55.944389], [-34.818718, -55.94411], [-34.819414, -55.943273], [-34.819185, -55.94102], [-34.818692, -55.941428], [-34.81834, -55.941814], [-34.818296, -55.943949]]}, {"id": "316", "territorio": "3", "coords": [[-34.819493, -55.943155], [-34.8193, -55.940956], [-34.819775, -55.94072], [-34.82018, -55.94057], [-34.820392, -55.941525], [-34.820577, -55.942125], [-34.820004, -55.942565]]}, {"id": "314", "territorio": "3", "coords": [[-34.818269, -55.941621], [-34.817468, -55.940173], [-34.818745, -55.93954], [-34.819335, -55.939078], [-34.820119, -55.940409], [-34.819555, -55.940623], [-34.81893, -55.940956]]}, {"id": "304 - B", "territorio": "3", "coords": [[-34.817802, -55.940913], [-34.817344, -55.940194], [-34.816455, -55.94057], [-34.815618, -55.940838], [-34.814896, -55.940913], [-34.81412, -55.940827], [-34.814684, -55.942651], [-34.815063, -55.943413], [-34.815724, -55.942898], [-34.815327, -55.941889], [-34.815371, -55.941718], [-34.816049, -55.941621], [-34.816411, -55.942222]]}, {"id": "304 - A", "territorio": "3", "coords": [[-34.816411, -55.942222], [-34.817793, -55.940924], [-34.81819, -55.941718], [-34.817529, -55.942769], [-34.817142, -55.94381], [-34.817001, -55.944368], [-34.816781, -55.945634], [-34.816243, -55.945119], [-34.815609, -55.944293], [-34.815133, -55.943542], [-34.815838, -55.942984], [-34.816023, -55.943359], [-34.816367, -55.94382], [-34.81656, -55.943584], [-34.816736, -55.942876]]}, {"id": "303", "territorio": "3", "coords": [[-34.816384, -55.94749], [-34.81649, -55.947307], [-34.816736, -55.94573], [-34.816243, -55.945258], [-34.81582, -55.944765], [-34.815107, -55.943745], [-34.814508, -55.944314], [-34.816217, -55.947415]]}, {"id": "305", "territorio": "3", "coords": [[-34.814006, -55.940806], [-34.812332, -55.940237], [-34.814288, -55.94382], [-34.814913, -55.943359], [-34.814402, -55.942222], [-34.8142, -55.941589]]}, {"id": "742|41 319", "territorio": "4", "coords": [[-34.822233, -55.944078], [-34.82439, -55.942329], [-34.823915, -55.941868], [-34.82373, -55.941632], [-34.822849, -55.942329], [-34.822004, -55.942833], [-34.821422, -55.943177]]}, {"id": "760|59 335", "territorio": "4", "coords": [[-34.824479, -55.942233], [-34.824038, -55.941836], [-34.823818, -55.941578], [-34.824804, -55.940784], [-34.825817, -55.939647], [-34.826425, -55.940666]]}, {"id": "336", "territorio": "4", "coords": [[-34.826531, -55.94057], [-34.827156, -55.940076], [-34.826258, -55.938263], [-34.825483, -55.938907]]}, {"id": "337", "territorio": "4", "coords": [[-34.825421, -55.938821], [-34.826196, -55.938166], [-34.824901, -55.935935], [-34.824065, -55.936761]]}, {"id": "338", "territorio": "4", "coords": [[-34.823985, -55.936579], [-34.824813, -55.935763], [-34.824047, -55.934476], [-34.82321, -55.935162]]}, {"id": "330", "territorio": "4", "coords": [[-34.823087, -55.935152], [-34.822056, -55.935752], [-34.821088, -55.936514], [-34.821643, -55.937297], [-34.821916, -55.937662], [-34.822603, -55.936793], [-34.822964, -55.9363], [-34.823404, -55.93586]]}, {"id": "323", "territorio": "4", "coords": [[-34.821845, -55.937759], [-34.820991, -55.9366], [-34.819943, -55.938284], [-34.819449, -55.93895], [-34.819855, -55.939636], [-34.820771, -55.939025]]}, {"id": "322", "territorio": "4", "coords": [[-34.820277, -55.940377], [-34.819934, -55.939701], [-34.82107, -55.938917], [-34.821924, -55.937866], [-34.822241, -55.938563], [-34.822479, -55.939196], [-34.82188, -55.939808], [-34.821352, -55.940108]]}, {"id": "331", "territorio": "4", "coords": [[-34.822576, -55.939057], [-34.822012, -55.937769], [-34.822937, -55.936493], [-34.823474, -55.935978], [-34.823897, -55.936707], [-34.82358, -55.937115], [-34.82292, -55.938478]]}, {"id": "332", "territorio": "4", "coords": [[-34.822911, -55.940076], [-34.822629, -55.939271], [-34.823254, -55.938123], [-34.823651, -55.937287], [-34.823985, -55.936857], [-34.824408, -55.937608], [-34.823853, -55.938842], [-34.82336, -55.939615]]}, {"id": "333", "territorio": "4", "coords": [[-34.823157, -55.94072], [-34.822937, -55.940226], [-34.823659, -55.939389], [-34.824487, -55.937673], [-34.82513, -55.93866], [-34.824153, -55.93984], [-34.823977, -55.940065]]}, {"id": "334", "territorio": "4", "coords": [[-34.825738, -55.93955], [-34.825201, -55.938735], [-34.824161, -55.940001], [-34.82321, -55.940838], [-34.823748, -55.941449], [-34.824778, -55.940666]]}, {"id": "320", "territorio": "4", "coords": [[-34.821343, -55.943069], [-34.822603, -55.942383], [-34.823677, -55.941557], [-34.823113, -55.940924], [-34.821678, -55.941653], [-34.820771, -55.942136], [-34.820938, -55.942608]]}, {"id": "321", "territorio": "4", "coords": [[-34.820727, -55.942018], [-34.820498, -55.941246], [-34.82033, -55.940527], [-34.821229, -55.940377], [-34.821801, -55.940076], [-34.822559, -55.939389], [-34.823078, -55.940816]]}, {"id": "339", "territorio": "6", "coords": [[-34.824038, -55.934347], [-34.823166, -55.932813], [-34.822409, -55.933456], [-34.823127, -55.93506], [-34.823184, -55.935055]]}, {"id": "329", "territorio": "6", "coords": [[-34.82103, -55.936439], [-34.820462, -55.935398], [-34.821074, -55.934921], [-34.822008, -55.934304], [-34.822528, -55.933843], [-34.823069, -55.935076], [-34.822457, -55.935425], [-34.821704, -55.935881]]}, {"id": "324", "territorio": "6", "coords": [[-34.819379, -55.93888], [-34.818635, -55.937673], [-34.818855, -55.937501], [-34.819727, -55.936224], [-34.820009, -55.935822], [-34.820431, -55.935447], [-34.820991, -55.936498], [-34.820665, -55.936997], [-34.819956, -55.938129]]}, {"id": "325", "territorio": "6", "coords": [[-34.818599, -55.937614], [-34.818036, -55.936294], [-34.819326, -55.934969], [-34.81989, -55.934476], [-34.820379, -55.935382], [-34.820057, -55.935672], [-34.819524, -55.936407], [-34.818925, -55.937281], [-34.818793, -55.937458]]}, {"id": "328", "territorio": "6", "coords": [[-34.820436, -55.935345], [-34.819929, -55.934443], [-34.820929, -55.933687], [-34.822101, -55.933006], [-34.822492, -55.933789], [-34.821823, -55.934352], [-34.820876, -55.934964]]}, {"id": "815|43 340", "territorio": "6", "coords": [[-34.822391, -55.933403], [-34.821453, -55.931718], [-34.822193, -55.931091], [-34.823131, -55.932781]]}, {"id": "814|42", "territorio": "6", "coords": [[-34.821422, -55.931659], [-34.822153, -55.931037], [-34.821066, -55.92924], [-34.820304, -55.929857]]}, {"id": "810|38", "territorio": "6", "coords": [[-34.81989, -55.931541], [-34.819375, -55.930619], [-34.820264, -55.929894], [-34.820823, -55.930817]]}, {"id": "809|37", "territorio": "6", "coords": [[-34.820405, -55.932523], [-34.819929, -55.9316], [-34.82085, -55.93086], [-34.821374, -55.931702]]}, {"id": "808|36 327", "territorio": "6", "coords": [[-34.819894, -55.934384], [-34.819348, -55.93343], [-34.820339, -55.932657], [-34.821414, -55.931756], [-34.822061, -55.932952], [-34.821334, -55.93336], [-34.820969, -55.933569]]}, {"id": "806|34", "territorio": "6", "coords": [[-34.818824, -55.932362], [-34.81981, -55.93159], [-34.819326, -55.930699], [-34.818436, -55.931418]]}, {"id": "807|35", "territorio": "6", "coords": [[-34.819308, -55.933365], [-34.82037, -55.932555], [-34.819868, -55.931633], [-34.81885, -55.932496]]}, {"id": "802|30", "territorio": "6", "coords": [[-34.81926, -55.933387], [-34.818758, -55.932496], [-34.818516, -55.931906], [-34.818344, -55.93145], [-34.81752, -55.932121], [-34.818163, -55.933172], [-34.818304, -55.933381], [-34.818903, -55.933746]]}, {"id": "799|27", "territorio": "6", "coords": [[-34.817093, -55.93388], [-34.816516, -55.93284], [-34.817472, -55.932148], [-34.818238, -55.933397]]}, {"id": "800|28", "territorio": "6", "coords": [[-34.817124, -55.93395], [-34.818282, -55.933435], [-34.81885, -55.933805], [-34.818168, -55.934401], [-34.817582, -55.934846]]}, {"id": "801|29 326", "territorio": "6", "coords": [[-34.817613, -55.93491], [-34.818053, -55.934561], [-34.818648, -55.934073], [-34.819291, -55.933456], [-34.819841, -55.934427], [-34.819313, -55.934878], [-34.81826, -55.935972], [-34.818018, -55.936235], [-34.817912, -55.935946], [-34.81778, -55.935484]]}, {"id": "794|22", "territorio": "5", "coords": [[-34.816948, -55.933918], [-34.816419, -55.932952], [-34.814913, -55.933961], [-34.815362, -55.934819], [-34.816146, -55.934283]]}, {"id": "313", "territorio": "5", "coords": [[-34.818234, -55.939647], [-34.81885, -55.939347], [-34.819264, -55.93896], [-34.818701, -55.938027], [-34.818525, -55.937748], [-34.817723, -55.937984]]}, {"id": "312", "territorio": "5", "coords": [[-34.817309, -55.940076], [-34.818137, -55.939722], [-34.817617, -55.938005], [-34.817054, -55.938199], [-34.81693, -55.938338], [-34.816921, -55.938531]]}, {"id": "311", "territorio": "5", "coords": [[-34.818463, -55.93763], [-34.817926, -55.936407], [-34.815688, -55.937823], [-34.816305, -55.940505], [-34.817203, -55.94014], [-34.816877, -55.938842], [-34.816825, -55.938531], [-34.816842, -55.938284], [-34.816992, -55.938091], [-34.817265, -55.937984], [-34.817688, -55.937855]]}, {"id": "791|19 310", "territorio": "5", "coords": [[-34.815653, -55.937694], [-34.81789, -55.936289], [-34.817512, -55.93498], [-34.816666, -55.935624], [-34.815512, -55.936654], [-34.815283, -55.936836]]}, {"id": "789|17", "territorio": "5", "coords": [[-34.814781, -55.935516], [-34.815283, -55.934862], [-34.814816, -55.934047], [-34.814341, -55.934722]]}, {"id": "790|18", "territorio": "5", "coords": [[-34.815239, -55.936718], [-34.815979, -55.936117], [-34.815345, -55.935001], [-34.814825, -55.935645]]}, {"id": "792|20", "territorio": "5", "coords": [[-34.816054, -55.936074], [-34.816675, -55.935516], [-34.816089, -55.934438], [-34.815569, -55.934781], [-34.815393, -55.934899]]}, {"id": "793|21", "territorio": "5", "coords": [[-34.816728, -55.935473], [-34.817512, -55.934905], [-34.817036, -55.933977], [-34.816477, -55.934245], [-34.816138, -55.934401]]}, {"id": "783|11", "territorio": "5", "coords": [[-34.814279, -55.934803], [-34.813733, -55.936187], [-34.813499, -55.936788], [-34.814116, -55.937571], [-34.814257, -55.937179], [-34.814438, -55.936509], [-34.814631, -55.935854], [-34.814719, -55.935634]]}, {"id": "779|7", "territorio": "5", "coords": [[-34.812385, -55.938912], [-34.812513, -55.93866], [-34.812852, -55.938], [-34.813178, -55.937389], [-34.813464, -55.936847], [-34.814076, -55.93763], [-34.813354, -55.9383], [-34.813107, -55.938504]]}, {"id": "782|10", "territorio": "5", "coords": [[-34.815177, -55.936793], [-34.814755, -55.935704], [-34.814706, -55.935801], [-34.814222, -55.937507]]}, {"id": "309", "territorio": "5", "coords": [[-34.814094, -55.940714], [-34.815014, -55.940816], [-34.815547, -55.940747], [-34.816234, -55.94057], [-34.815939, -55.939314], [-34.815199, -55.939556], [-34.815036, -55.939599], [-34.81453, -55.940006], [-34.8142, -55.940403], [-34.81412, -55.940559]]}, {"id": "781|9 30", "territorio": "5", "coords": [[-34.815931, -55.939239], [-34.815618, -55.937818], [-34.815195, -55.936863], [-34.814151, -55.93763], [-34.814482, -55.938413], [-34.814684, -55.938901], [-34.815019, -55.93954]]}, {"id": "708|8 306", "territorio": "5", "coords": [[-34.812138, -55.940065], [-34.812773, -55.940264], [-34.814574, -55.938789], [-34.814112, -55.937673], [-34.813284, -55.938451], [-34.813081, -55.93859], [-34.812354, -55.939003], [-34.812266, -55.939406]]}, {"id": "307", "territorio": "5", "coords": [[-34.812848, -55.940285], [-34.813799, -55.940639], [-34.814046, -55.94072], [-34.814063, -55.940559], [-34.814195, -55.940291], [-34.814556, -55.939888], [-34.814979, -55.939556], [-34.8146, -55.938864]]}, {"id": "703|1", "territorio": "7", "coords": [[-34.812108, -55.93977], [-34.811152, -55.937957], [-34.811901, -55.93734], [-34.812495, -55.938478], [-34.812319, -55.938848], [-34.8122, -55.939239]]}, {"id": "704|2", "territorio": "7", "coords": [[-34.811143, -55.937887], [-34.811861, -55.937297], [-34.811081, -55.93587], [-34.810337, -55.936482]]}, {"id": "778|6", "territorio": "7", "coords": [[-34.812513, -55.938413], [-34.811438, -55.936364], [-34.81279, -55.935844], [-34.813301, -55.936739], [-34.813385, -55.936798]]}, {"id": "777|5", "territorio": "7", "coords": [[-34.811416, -55.9363], [-34.811139, -55.935833], [-34.812244, -55.934835], [-34.812764, -55.935801]]}, {"id": "784|12", "territorio": "7", "coords": [[-34.813416, -55.936734], [-34.814024, -55.935189], [-34.813971, -55.935146], [-34.813777, -55.934975], [-34.81368, -55.934948], [-34.813557, -55.934975], [-34.812852, -55.935817], [-34.813341, -55.936686]]}, {"id": "785|13", "territorio": "7", "coords": [[-34.812817, -55.935747], [-34.812293, -55.934798], [-34.813469, -55.933945], [-34.81409, -55.934556], [-34.814204, -55.934706], [-34.81405, -55.935125], [-34.813971, -55.935066], [-34.813817, -55.93491], [-34.813667, -55.934878], [-34.81353, -55.934905]]}, {"id": "788|16", "territorio": "7", "coords": [[-34.814239, -55.934631], [-34.814129, -55.934481], [-34.813521, -55.933907], [-34.814349, -55.933108], [-34.814772, -55.933902], [-34.81446, -55.934288]]}, {"id": "795|23", "territorio": "7", "coords": [[-34.814393, -55.933076], [-34.815856, -55.931885], [-34.816384, -55.932791], [-34.814887, -55.933778], [-34.814825, -55.933843]]}, {"id": "796|24 518", "territorio": "7", "coords": [[-34.815807, -55.931836], [-34.814997, -55.93086], [-34.814649, -55.931386], [-34.814244, -55.931869], [-34.813905, -55.93219], [-34.814358, -55.933022]]}, {"id": "786|14 509", "territorio": "7", "coords": [[-34.813429, -55.933896], [-34.812627, -55.933086], [-34.812363, -55.933483], [-34.811967, -55.933918], [-34.811861, -55.934014], [-34.812257, -55.934733]]}, {"id": "775|3 501", "territorio": "7", "coords": [[-34.810302, -55.936412], [-34.80965, -55.935286], [-34.810209, -55.934202], [-34.81046, -55.934358], [-34.810535, -55.93439], [-34.810579, -55.934819], [-34.810773, -55.935323], [-34.811051, -55.935827]]}, {"id": "776|4 508", "territorio": "7", "coords": [[-34.810601, -55.934395], [-34.811042, -55.934384], [-34.811363, -55.934288], [-34.811808, -55.934052], [-34.8122, -55.934781], [-34.811103, -55.935785], [-34.810817, -55.935275], [-34.81065, -55.934867], [-34.810628, -55.934696]]}, {"id": "822|507", "territorio": "7", "coords": [[-34.810236, -55.934111], [-34.810817, -55.932968], [-34.811064, -55.933118], [-34.811258, -55.933177], [-34.81146, -55.933113], [-34.811641, -55.932958], [-34.811998, -55.932443], [-34.812597, -55.933043], [-34.812275, -55.93351], [-34.811808, -55.933982], [-34.811337, -55.934229], [-34.810892, -55.934342], [-34.810593, -55.934342]]}, {"id": "825|510", "territorio": "7", "coords": [[-34.810844, -55.932909], [-34.811385, -55.93181], [-34.81194, -55.932389], [-34.81161, -55.932899], [-34.811421, -55.93307], [-34.811275, -55.933097], [-34.811139, -55.933086]]}, {"id": "831|515", "territorio": "7", "coords": [[-34.811421, -55.931751], [-34.811804, -55.930983], [-34.812227, -55.930388], [-34.812535, -55.930082], [-34.812812, -55.929862], [-34.813676, -55.929283], [-34.814261, -55.930034], [-34.813781, -55.930286], [-34.813416, -55.930517], [-34.813103, -55.930774], [-34.812702, -55.931236], [-34.811984, -55.932325]]}, {"id": "832|516", "territorio": "7", "coords": [[-34.812033, -55.932373], [-34.812764, -55.931252], [-34.813182, -55.930812], [-34.813517, -55.930538], [-34.81394, -55.930275], [-34.814327, -55.930082], [-34.814935, -55.930785], [-34.814393, -55.931016], [-34.813975, -55.93123], [-34.813605, -55.931563], [-34.813134, -55.932201], [-34.812909, -55.932566], [-34.812627, -55.932984]]}, {"id": "838|521", "territorio": "8", "coords": [[-34.814371, -55.92997], [-34.81375, -55.929224], [-34.816168, -55.927582], [-34.816604, -55.928054], [-34.816882, -55.928344], [-34.815622, -55.929272]]}, {"id": "837|520", "territorio": "8", "coords": [[-34.814416, -55.930023], [-34.815433, -55.929465], [-34.816036, -55.929068], [-34.816578, -55.928655], [-34.816935, -55.928376], [-34.81723, -55.928827], [-34.817402, -55.929202], [-34.816565, -55.929894], [-34.816151, -55.9302], [-34.815481, -55.930549], [-34.815041, -55.930753]]}, {"id": "797|25 519", "territorio": "8", "coords": [[-34.815094, -55.930796], [-34.816001, -55.930356], [-34.816507, -55.930029], [-34.81745, -55.929261], [-34.817846, -55.930308], [-34.817265, -55.930683], [-34.816974, -55.930871], [-34.816675, -55.931118], [-34.815887, -55.931777]]}, {"id": "798|26", "territorio": "8", "coords": [[-34.816459, -55.932732], [-34.81741, -55.932056], [-34.816855, -55.931048], [-34.815931, -55.931831]]}, {"id": "803|31", "territorio": "8", "coords": [[-34.816913, -55.93101], [-34.817133, -55.930833], [-34.817877, -55.930367], [-34.8183, -55.931359], [-34.817468, -55.932013]]}, {"id": "805|33", "territorio": "8", "coords": [[-34.818357, -55.931305], [-34.81793, -55.930345], [-34.81878, -55.929632], [-34.819264, -55.93057]]}, {"id": "811|39", "territorio": "8", "coords": [[-34.818828, -55.929589], [-34.819696, -55.92895], [-34.820194, -55.929814], [-34.819326, -55.930533]]}, {"id": "813|41", "territorio": "8", "coords": [[-34.819744, -55.928918], [-34.82048, -55.928253], [-34.821008, -55.929149], [-34.820251, -55.929776]]}, {"id": "812|40 529", "territorio": "8", "coords": [[-34.820436, -55.928194], [-34.819397, -55.926397], [-34.818599, -55.926842], [-34.81885, -55.927491], [-34.819057, -55.927856], [-34.819344, -55.928264], [-34.819705, -55.928864]]}, {"id": "847|530", "territorio": "8", "coords": [[-34.818573, -55.926767], [-34.819379, -55.926327], [-34.818798, -55.925303], [-34.818463, -55.924627], [-34.817758, -55.925227], [-34.818163, -55.925844]]}, {"id": "843|526", "territorio": "8", "coords": [[-34.816221, -55.92755], [-34.816811, -55.927132], [-34.817155, -55.926724], [-34.81734, -55.926263], [-34.817459, -55.925608], [-34.817498, -55.925469], [-34.81771, -55.925254], [-34.818243, -55.926139], [-34.818511, -55.926805], [-34.816935, -55.928269]]}, {"id": "844|527", "territorio": "8", "coords": [[-34.816979, -55.928339], [-34.817846, -55.927502], [-34.818547, -55.926874], [-34.818714, -55.927352], [-34.818983, -55.92784], [-34.817463, -55.92916], [-34.817278, -55.928757]]}, {"id": "804|32 528", "territorio": "8", "coords": [[-34.81749, -55.929224], [-34.819022, -55.927894], [-34.819463, -55.928591], [-34.819656, -55.928897], [-34.818767, -55.929551], [-34.817908, -55.930265]]}, {"id": "846|531 890|40", "territorio": "10", "coords": [[-34.817428, -55.925383], [-34.817661, -55.925163], [-34.818419, -55.924541], [-34.817829, -55.923393], [-34.817349, -55.922545], [-34.816855, -55.923076], [-34.816648, -55.923312], [-34.817036, -55.923983], [-34.817217, -55.924353], [-34.817327, -55.925034], [-34.817362, -55.92526]]}, {"id": "889|39", "territorio": "10", "coords": [[-34.8166, -55.923259], [-34.817327, -55.922481], [-34.816547, -55.921134], [-34.815891, -55.919954], [-34.815243, -55.920491], [-34.815503, -55.921177], [-34.81564, -55.922019], [-34.815926, -55.922293]]}, {"id": "842|525", "territorio": "10", "coords": [[-34.815455, -55.926472], [-34.815706, -55.926917], [-34.816151, -55.927464], [-34.816803, -55.927008], [-34.817102, -55.92659], [-34.817225, -55.926279], [-34.817318, -55.925871], [-34.817384, -55.92549], [-34.816864, -55.925496], [-34.816248, -55.925737], [-34.815746, -55.926182]]}, {"id": "841|524 879|29", "territorio": "10", "coords": [[-34.817371, -55.92541], [-34.817313, -55.925324], [-34.817225, -55.924771], [-34.81715, -55.924348], [-34.816609, -55.923377], [-34.81608, -55.924374], [-34.815957, -55.924573], [-34.815697, -55.92482], [-34.814896, -55.92549], [-34.815402, -55.926408], [-34.816019, -55.925855], [-34.816208, -55.925705], [-34.816604, -55.925512], [-34.816851, -55.925453]]}, {"id": "880|30", "territorio": "10", "coords": [[-34.814442, -55.924525], [-34.814649, -55.925045], [-34.814852, -55.925426], [-34.815759, -55.924702], [-34.815953, -55.924471], [-34.816569, -55.923312], [-34.815878, -55.922357], [-34.81564, -55.922089], [-34.815556, -55.922658], [-34.815402, -55.923216], [-34.815138, -55.923774], [-34.814874, -55.924149], [-34.814645, -55.924364]]}, {"id": "881|31", "territorio": "10", "coords": [[-34.813883, -55.923162], [-34.814402, -55.924466], [-34.814763, -55.924187], [-34.814992, -55.923902], [-34.815314, -55.923285], [-34.81549, -55.922658], [-34.815578, -55.922078], [-34.815512, -55.922084], [-34.814852, -55.922438], [-34.814367, -55.922728], [-34.814059, -55.922974]]}, {"id": "882|32", "territorio": "10", "coords": [[-34.813385, -55.922019], [-34.815204, -55.920528], [-34.815446, -55.921188], [-34.815574, -55.922019], [-34.815503, -55.92203], [-34.814671, -55.92247], [-34.814319, -55.922695], [-34.813997, -55.922953], [-34.813852, -55.923087]]}, {"id": "839|522", "territorio": "10", "coords": [[-34.81368, -55.929101], [-34.816032, -55.927491], [-34.8156, -55.926944], [-34.815354, -55.92659], [-34.814843, -55.927094], [-34.81324, -55.928296]]}, {"id": "840|523 878|28", "territorio": "10", "coords": [[-34.813187, -55.928189], [-34.814402, -55.927309], [-34.815318, -55.926472], [-34.814772, -55.925603], [-34.812702, -55.92733]]}, {"id": "877|27", "territorio": "10", "coords": [[-34.812641, -55.927212], [-34.814755, -55.925496], [-34.814323, -55.924605], [-34.812288, -55.925957], [-34.812438, -55.926644]]}, {"id": "876|26", "territorio": "10", "coords": [[-34.812244, -55.925817], [-34.814261, -55.924476], [-34.813777, -55.923285], [-34.813248, -55.923951], [-34.812914, -55.924294], [-34.811962, -55.924906]]}, {"id": "875|25", "territorio": "10", "coords": [[-34.811918, -55.924798], [-34.811355, -55.923672], [-34.813301, -55.922137], [-34.813742, -55.923189], [-34.813028, -55.924058], [-34.812641, -55.924337]]}, {"id": "817|505", "territorio": "9", "coords": [[-34.809566, -55.935044], [-34.810042, -55.9341], [-34.809751, -55.933832], [-34.809496, -55.933478], [-34.808641, -55.931911], [-34.807981, -55.932255]]}, {"id": "817|502", "territorio": "9", "coords": [[-34.810667, -55.93292], [-34.810121, -55.934036], [-34.80991, -55.933821], [-34.809593, -55.933435], [-34.809417, -55.933113], [-34.808729, -55.931869], [-34.809091, -55.931643]]}, {"id": "826|511", "territorio": "9", "coords": [[-34.811266, -55.931718], [-34.810747, -55.932823], [-34.80998, -55.932212], [-34.810711, -55.93101], [-34.810993, -55.931439]]}, {"id": "827|512", "territorio": "9", "coords": [[-34.809157, -55.931568], [-34.809985, -55.930914], [-34.810408, -55.930527], [-34.810659, -55.930946], [-34.809914, -55.932126]]}, {"id": "830|514", "territorio": "9", "coords": [[-34.813574, -55.929176], [-34.813125, -55.92836], [-34.811733, -55.929412], [-34.810782, -55.930946], [-34.811037, -55.931311], [-34.811346, -55.931633], [-34.811857, -55.930592], [-34.812376, -55.930012], [-34.812975, -55.929573]]}, {"id": "828|513 861|13", "territorio": "9", "coords": [[-34.810421, -55.930388], [-34.809866, -55.929508], [-34.810271, -55.929015], [-34.8108, -55.928682], [-34.811205, -55.928457], [-34.812605, -55.927427], [-34.813072, -55.928296], [-34.81102, -55.929766]]}, {"id": "819|504 860|12", "territorio": "9", "coords": [[-34.808685, -55.931751], [-34.808227, -55.930946], [-34.808862, -55.93056], [-34.809804, -55.929594], [-34.810324, -55.930485], [-34.809575, -55.931107]]}, {"id": "818|503 849|1", "territorio": "9", "coords": [[-34.807906, -55.93219], [-34.808619, -55.93182], [-34.808144, -55.930957], [-34.807593, -55.931112], [-34.80754, -55.93116], [-34.807505, -55.931327], [-34.807386, -55.931466], [-34.807624, -55.931938]]}, {"id": "859|11", "territorio": "9", "coords": [[-34.80762, -55.931032], [-34.808122, -55.930903], [-34.808566, -55.930656], [-34.808954, -55.930356], [-34.809765, -55.929481], [-34.809654, -55.929331], [-34.809342, -55.928339], [-34.808197, -55.929852], [-34.807844, -55.930442], [-34.80765, -55.930849]]}, {"id": "850|2", "territorio": "9", "coords": [[-34.807796, -55.930361], [-34.806496, -55.928065], [-34.806325, -55.927759], [-34.806236, -55.927942], [-34.805787, -55.928344], [-34.805615, -55.928339], [-34.805783, -55.928666], [-34.807219, -55.931225], [-34.807346, -55.931091], [-34.807505, -55.931085], [-34.807558, -55.93101], [-34.807611, -55.930817]]}, {"id": "858|10", "territorio": "9", "coords": [[-34.80784, -55.930313], [-34.807289, -55.92932], [-34.808086, -55.928146], [-34.808549, -55.927497], [-34.80895, -55.927083], [-34.809311, -55.928264], [-34.80821, -55.929734]]}, {"id": "879|9", "territorio": "9", "coords": [[-34.80636, -55.927679], [-34.808465, -55.925989], [-34.808765, -55.926579], [-34.808919, -55.92703], [-34.80847, -55.927464], [-34.807263, -55.92924]]}, {"id": "865|16", "territorio": "9", "coords": [[-34.808553, -55.925936], [-34.811293, -55.923736], [-34.811804, -55.924873], [-34.810245, -55.92571], [-34.809734, -55.926129], [-34.808976, -55.926933], [-34.808774, -55.926354]]}, {"id": "864|15", "territorio": "9", "coords": [[-34.809364, -55.928135], [-34.80902, -55.927062], [-34.809804, -55.926247], [-34.810333, -55.925796], [-34.811857, -55.924981], [-34.812138, -55.925903], [-34.81072, -55.926794], [-34.810139, -55.927191], [-34.809725, -55.927674]]}, {"id": "863|14", "territorio": "9", "coords": [[-34.809795, -55.929369], [-34.809698, -55.929165], [-34.809399, -55.928242], [-34.81028, -55.927202], [-34.812183, -55.926032], [-34.812561, -55.927309], [-34.811954, -55.927341], [-34.81131, -55.927598], [-34.810747, -55.928028], [-34.810368, -55.928564], [-34.810253, -55.928843]]}, {"id": "851|3", "territorio": "11", "coords": [[-34.80551, -55.928162], [-34.805461, -55.928081], [-34.804259, -55.925995], [-34.805016, -55.925394], [-34.806236, -55.927609], [-34.806096, -55.92762], [-34.805999, -55.927652], [-34.805607, -55.927958]]}, {"id": "852|4", "territorio": "11", "coords": [[-34.804219, -55.925914], [-34.803237, -55.924133], [-34.803959, -55.923548], [-34.80458, -55.924444], [-34.804981, -55.925362]]}, {"id": "J1|528", "territorio": "11", "coords": [[-34.80318, -55.924031], [-34.802048, -55.921987], [-34.802704, -55.921429], [-34.803475, -55.922787]]}, {"id": "J2|529", "territorio": "11", "coords": [[-34.802012, -55.921928], [-34.801541, -55.921059], [-34.8014, -55.920796], [-34.801136, -55.920212], [-34.802193, -55.920523], [-34.802664, -55.921365]]}, {"id": "J6|533 J5|532 J10|537 J9|536", "territorio": "11", "coords": [[-34.803497, -55.922642], [-34.802281, -55.920528], [-34.804316, -55.919777], [-34.805593, -55.919166], [-34.806034, -55.920528]]}, {"id": "J7|534", "territorio": "11", "coords": [[-34.803276, -55.923972], [-34.803558, -55.922738], [-34.80495, -55.92158], [-34.805329, -55.922298]]}, {"id": "835|5", "territorio": "11", "coords": [[-34.804043, -55.9235], [-34.805417, -55.922406], [-34.805637, -55.922813], [-34.805963, -55.923135], [-34.805179, -55.92365], [-34.804871, -55.92394], [-34.804607, -55.924326]]}, {"id": "866|17", "territorio": "11", "coords": [[-34.808483, -55.925807], [-34.811187, -55.923575], [-34.810447, -55.922674], [-34.809179, -55.924058], [-34.807893, -55.924981]]}, {"id": "856|8", "territorio": "11", "coords": [[-34.806307, -55.927534], [-34.805602, -55.926279], [-34.806712, -55.925721], [-34.807787, -55.925045], [-34.808368, -55.925903]]}, {"id": "854|6", "territorio": "11", "coords": [[-34.804677, -55.924444], [-34.804915, -55.924058], [-34.805417, -55.923607], [-34.806051, -55.923178], [-34.806968, -55.924058], [-34.806184, -55.924401], [-34.80503, -55.92526]]}, {"id": "855|7", "territorio": "11", "coords": [[-34.805541, -55.926193], [-34.8051, -55.925399], [-34.805902, -55.924702], [-34.807056, -55.924144], [-34.807743, -55.924948], [-34.806668, -55.925603]]}, {"id": "867|18", "territorio": "11", "coords": [[-34.807822, -55.924852], [-34.80717, -55.924101], [-34.808183, -55.923446], [-34.808712, -55.92306], [-34.809628, -55.921977], [-34.810377, -55.922599], [-34.809143, -55.92394]]}, {"id": "869|19", "territorio": "11", "coords": [[-34.807065, -55.923951], [-34.80614, -55.923125], [-34.807241, -55.922116], [-34.808527, -55.921322], [-34.809452, -55.921901], [-34.808879, -55.922062], [-34.808289, -55.922374], [-34.807743, -55.922792], [-34.807188, -55.92364]]}, {"id": "870|20", "territorio": "11", "coords": [[-34.806051, -55.923028], [-34.805734, -55.922728], [-34.805479, -55.922341], [-34.806545, -55.921451], [-34.807866, -55.920421], [-34.808174, -55.92099], [-34.808404, -55.921258], [-34.807082, -55.922105]]}, {"id": "J8|535", "territorio": "11", "coords": [[-34.805435, -55.922213], [-34.807452, -55.920539], [-34.806862, -55.920002], [-34.805012, -55.921504]]}, {"id": "J12|539", "territorio": "11", "coords": [[-34.806131, -55.920464], [-34.805681, -55.919144], [-34.806474, -55.918822], [-34.806774, -55.919906]]}, {"id": "J13|541", "territorio": "12", "coords": [[-34.806871, -55.919852], [-34.806571, -55.918779], [-34.808263, -55.918082], [-34.808421, -55.918586]]}, {"id": "J15|542", "territorio": "12", "coords": [[-34.807549, -55.920496], [-34.806968, -55.919949], [-34.808474, -55.918715], [-34.808862, -55.919455]]}, {"id": "J16|543", "territorio": "12", "coords": [[-34.80895, -55.91938], [-34.808562, -55.91864], [-34.809742, -55.917674], [-34.810016, -55.917363], [-34.810324, -55.917224], [-34.810465, -55.917803], [-34.810474, -55.918071]]}, {"id": "J19|546", "territorio": "12", "coords": [[-34.810632, -55.917953], [-34.810579, -55.917588], [-34.810482, -55.91717], [-34.811249, -55.916816], [-34.811839, -55.917031]]}, {"id": "888|38", "territorio": "12", "coords": [[-34.815785, -55.919842], [-34.81427, -55.917192], [-34.813372, -55.917739], [-34.814112, -55.919069], [-34.814552, -55.919477], [-34.815177, -55.920367]]}, {"id": "887|37", "territorio": "12", "coords": [[-34.814226, -55.917084], [-34.813407, -55.915915], [-34.812685, -55.916483], [-34.813319, -55.917621]]}, {"id": "883|33", "territorio": "12", "coords": [[-34.813336, -55.921869], [-34.815098, -55.920421], [-34.814323, -55.919402], [-34.813521, -55.920324], [-34.812729, -55.920914]]}, {"id": "884|34", "territorio": "12", "coords": [[-34.812649, -55.920829], [-34.811848, -55.91982], [-34.812693, -55.919348], [-34.813231, -55.919133], [-34.813979, -55.91908], [-34.814244, -55.919359], [-34.813389, -55.920314]]}, {"id": "885|35", "territorio": "12", "coords": [[-34.811742, -55.919745], [-34.811125, -55.919048], [-34.812086, -55.918264], [-34.813266, -55.917771], [-34.813935, -55.918972], [-34.813433, -55.918994], [-34.812658, -55.919219]]}, {"id": "886|36", "territorio": "12", "coords": [[-34.810676, -55.918093], [-34.812605, -55.916537], [-34.813204, -55.917685], [-34.812086, -55.918136], [-34.811073, -55.918951], [-34.810791, -55.918533]]}, {"id": "871|21", "territorio": "12", "coords": [[-34.807963, -55.920346], [-34.810526, -55.9182], [-34.810685, -55.918683], [-34.810932, -55.919091], [-34.808527, -55.921193], [-34.808271, -55.920925]]}, {"id": "872|22", "territorio": "12", "coords": [[-34.808615, -55.921258], [-34.81102, -55.919166], [-34.811592, -55.919842], [-34.809593, -55.921848]]}, {"id": "873|23", "territorio": "12", "coords": [[-34.809716, -55.921901], [-34.811698, -55.919895], [-34.8125, -55.920914], [-34.811451, -55.921462], [-34.810421, -55.922524]]}, {"id": "874|24", "territorio": "12", "coords": [[-34.811258, -55.923511], [-34.810905, -55.922996], [-34.810509, -55.922577], [-34.811434, -55.921569], [-34.812579, -55.921011], [-34.813187, -55.921977]]}, {"id": "196B|167", "territorio": "19", "coords": [[-34.799858, -55.905422], [-34.800378, -55.904961], [-34.801277, -55.90584], [-34.800783, -55.906945], [-34.800642, -55.906742]]}, {"id": "216|57", "territorio": "19", "coords": [[-34.800493, -55.904896], [-34.802616, -55.903158], [-34.803136, -55.903641], [-34.802554, -55.904746], [-34.801347, -55.905744]]}, {"id": "196|166", "territorio": "19", "coords": [[-34.80088, -55.907031], [-34.801365, -55.905883], [-34.802633, -55.906667], [-34.802237, -55.908008]]}, {"id": "215|56", "territorio": "19", "coords": [[-34.80147, -55.905797], [-34.802651, -55.90481], [-34.803215, -55.903705], [-34.8034, -55.903866], [-34.802695, -55.906527], [-34.80207, -55.906259]]}, {"id": "258|76", "territorio": "22", "coords": [[-34.802695, -55.903094], [-34.804316, -55.901796], [-34.804466, -55.901731], [-34.804466, -55.903662], [-34.804439, -55.904274], [-34.80347, -55.90378]]}, {"id": "214|75", "territorio": "19", "coords": [[-34.802792, -55.906559], [-34.803506, -55.903888], [-34.804052, -55.904242], [-34.804422, -55.904371], [-34.803823, -55.906806], [-34.803153, -55.906688]]}, {"id": "195|113", "territorio": "19", "coords": [[-34.802343, -55.908051], [-34.802748, -55.906677], [-34.803109, -55.906817], [-34.803779, -55.906945], [-34.803329, -55.908587], [-34.803232, -55.90863]]}, {"id": "256|523", "territorio": "22", "coords": [[-34.804651, -55.902826], [-34.804642, -55.901796], [-34.804756, -55.901399], [-34.805655, -55.900948], [-34.805752, -55.90215], [-34.805884, -55.902708], [-34.805734, -55.902869]]}, {"id": "256B|81", "territorio": "22", "coords": [[-34.805981, -55.902654], [-34.805849, -55.902107], [-34.80577, -55.900927], [-34.806413, -55.900573], [-34.806985, -55.901903]]}, {"id": "257|80", "territorio": "22", "coords": [[-34.804571, -55.904242], [-34.804633, -55.903652], [-34.804633, -55.902954], [-34.805699, -55.902976], [-34.805373, -55.904542]]}, {"id": "1", "territorio": "12", "coords": [[-34.802748, -55.912718], [-34.80362, -55.913308], [-34.80399, -55.911559], [-34.803259, -55.911409]]}];

function prepararPoligonosBase() {
  const arr = Array.isArray(POLIGONOS_EMBEBIDOS) ? POLIGONOS_EMBEBIDOS : [];
  return arr.map(p => ({ ...p }));
}

// ====== Lectura de Sheets y pintado inicial ======
async function refreshFromSheet() {
  try {
    const base = prepararPoligonosBase();
    const datosSheets = await cargarDatosDesdeSheets();
    let merged = mergeSheets(base, datosSheets);
    merged = mergeRealizacionesLocales(merged);
    pintar(merged);
    setStatus('Actualizado desde Sheets (' + new Date().toLocaleTimeString() + ').');
  } catch (e) {
    console.warn('Refresh desde Sheets falló:', e);
    setStatus('No se pudo actualizar desde Sheets.');
  }
}

(async function init() {
  try {
    const base = prepararPoligonosBase();
    const datosSheets = await cargarDatosDesdeSheets();
    let merged = mergeSheets(base, datosSheets);
    merged = mergeRealizacionesLocales(merged);
    pintar(merged);
    startAutoRefresh();
    setStatus('Datos cargados. Auto-refresh activo (5m).');
  } catch (e) {
    console.error(e);
    setStatus('Error al cargar datos: ' + (e?.message ?? e));
  }
})();
</script>
</body>
</html>
