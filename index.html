<!DOCTYPE html>
<html lang="es">
<head>

<style>
  /* ===== Desktop login styling & global form fixes ===== */
  /* Backdrop */
  #login-overlay{
    position: fixed;
    inset: 0;
    z-index: 4000;
    background: rgba(0,0,0,.55);
    display: none; /* toggled via JS */
    align-items: center;
    justify-content: center;
    padding: 24px;
    backdrop-filter: blur(1.5px);
  }
  /* Modal container */
  #login-modal{
    background: #0f172a;           /* slate-900 */
    color: #e5e7eb;                /* gray-200 */
    width: 100%;
    max-width: 480px;
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
    overflow: hidden;
    border: 1px solid rgba(255,255,255,.06);
  }
  /* Header / Body */
  #login-modal header{
    display:flex; align-items:center; justify-content:space-between;
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
  }
  #login-modal header h3{
    margin:0; font: 600 16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    letter-spacing: .2px;
  }
  #login-modal .modal-body{
    padding: 16px;
    display: grid;
    gap: 10px;
  }
  #login-modal .form-field{ display:grid; gap:6px; }
  #login-modal .form-label{ font-size: 13px; color: #cbd5e1; } /* slate-300 */
  #login-modal .form-input{
    width:100%;
    border: 1px solid #334155;     /* slate-700 */
    background: #0b1220;           /* deep slate */
    color: #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
    outline: none;
  }
  #login-modal .form-input:focus{
    border-color: #60a5fa;         /* blue-400 */
    box-shadow: 0 0 0 3px rgba(96,165,250,.2);
  }
  #login-modal .form-actions{
    display:flex; gap:8px; justify-content:flex-end; margin-top:8px;
  }
  #login-modal .btn-primary{
    background:#2563eb; color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer;
  }
  #login-modal .btn-cancel{
    background:#1f2937; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px 14px; cursor:pointer;
  }
  #login-modal .btn-primary:hover{ filter:brightness(1.06); }
  #login-modal .btn-cancel:hover{ filter:brightness(1.05); }

  /* Close button (if exists) */
  #login-modal .modal-close-btn{
    border:none; background:transparent; color:#94a3b8;
    font-size:18px; cursor:pointer; line-height:1;
  }
  #login-modal .modal-close-btn:hover{ color:#e2e8f0; }

  /* Leaflet controls sit below auth bar & modal */
  .leaflet-top, .leaflet-bottom{ z-index: 2000; }
  /* Floating refs button must be above Leaflet controls but below modal */
  .refs-toggle{ z-index: 2500; }

  /* ---- General form tidy for the registro modal to avoid clashing ---- */
  .modal-card input, .modal-card select, .modal-card textarea,
  #territorio-overlay input, #territorio-overlay select, #territorio-overlay textarea{
    font: 500 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    border-radius: 10px;
    border: 1px solid #334155;
    background: #0b1220;
    color: #e5e7eb;
    padding: 10px 12px;
    outline: none;
  }
  #territorio-overlay label{ color:#cbd5e1; font-size: 13px; }
  #territorio-overlay footer button{
    border-radius: 10px; padding:10px 14px;
  }
  #territorio-overlay footer .btn{ background:#2563eb; color:#fff; border:none; }
  #territorio-overlay footer .btn.secondary{ background:#1f2937; color:#e5e7eb; border:1px solid #334155; }

  /* Desktop layout polish for modal widths */
  @media (min-width: 769px){
    #login-modal{ max-width: 520px; }
  }
</style>



<style>
  /* Botón flotante "Referencias" (aparece en pantallas pequeñas) */
  .refs-toggle{
    position:fixed;
    right:14px;
    bottom:14px;
    z-index:2500;
    display:none; /* visible sólo en mobile via @media */
    padding:10px 14px;
    border:none;
    border-radius:999px;
    background:#111;
    color:#fff;
    font:600 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
    cursor:pointer;
  }
  .refs-toggle:active{ transform:translateY(1px); }

  /* Panel con animación de deslizado */
  #referencias{
    will-change: max-height, opacity;
    transition: max-height 250ms ease, opacity 200ms ease;
  }

  /* Sólo en mobile mostramos el botón y colapsamos por defecto */
  @media (max-width: 768px){
    .refs-toggle{ display:inline-flex; align-items:center; gap:8px; }
  }
</style>



<!-- Auth + Config -->
<script src="./app-config.js"></script>
<script src="./app-auth.js"></script>

<style>
  /* ===== Login modal minimal styles (compatible con index.slim2.html) ===== */
  .auth-hidden{ display:none !important; }
  .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:3000; }
  .modal-card{ width:92%; max-width:420px; background:#fff; color:#111; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
  .modal-title{ margin:0; font:600 16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .modal-close-btn{ border:none; background:transparent; font-size:18px; cursor:pointer; }
  .modal-body{ padding:14px; display:grid; gap:10px; }
  .form-field{ display:grid; gap:4px; }
  .form-label{ font-size:14px; }
  .form-input{ width:100%; border:1px solid #ccc; border-radius:8px; padding:8px 10px; font-size:14px; }
  .form-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:6px; }
  .btn-primary{ background:#111; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn-cancel{ background:#e5e7eb; color:#111; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  /* Barra simple arriba a la derecha */
  #auth-bar{ position:fixed; right:10px; top:10px; z-index:3100; display:flex; gap:8px; align-items:center; }
  #auth-bar .pill{ background:rgba(0,0,0,.75); color:#fff; padding:6px 10px; border-radius:999px; font:500 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  #btnAuthOpen, #btnLogout{ border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
  #btnAuthOpen{ background:#2563eb; color:#fff; }
  #btnLogout{ background:#ef4444; color:#fff; }
  #btnRefresh{
    background:rgba(0,0,0,.75);
    color:#fff;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    min-width:38px;
  }
  #btnRefresh:hover{ filter:brightness(1.06); }
  #btnRefresh:disabled{ opacity:.6; cursor:default; }

  @keyframes spin{ from{ transform:rotate(0deg);} to{ transform:rotate(360deg);} }
  #btnRefresh.loading{ animation: spin 0.9s linear infinite; }

  @media (max-width: 768px){
    #auth-bar{ right:8px; top:8px; gap:6px; }
    #auth-bar .pill{ display:none; } /* en mobile gana espacio */
    #btnAuthOpen, #btnLogout, #btnRefresh{ padding:8px 10px; border-radius:999px; }
  }
</style>


  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Territorios Lomas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    /* Cartel del número de POLÍGONO (p.id) */
    
.numero-cartel {
  color: #ffffff;
  font-size: 10px;
  font-weight: bold;
  text-shadow: 0 0 6px rgba(0,0,0,0.6);
  background-color: rgba(205, 212, 221, 0.45); /* azul translúcido */
  padding: 8px 12px;
  border-radius: 10px;
  border: 2px solid rgba(255,255,255,0.4);
  pointer-events: none;
  user-select: none;
  transform: translate(-50%, -50%);
  line-height: 1;
  white-space: nowrap;
}

.numero-cartel-fijo {
  color: #fff;
  font-size: 20px;
  font-weight: bold;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
  background-color: rgba(0, 128, 255, 0.45); /* azul translúcido */
  padding: 3px 5px;
  border-radius: 5px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  pointer-events: none;
  user-select: none;
  transform: translate(-50%, -50%);
  line-height: 1;
}



    .modal input, .modal textarea, .modal select  {
      width: 90% !important;
    }

    /* Panel de referencias */
    #referencias {
      position: fixed; top: 10px; left: 10px; z-index: 1000;
      background: rgba(0,0,0,.8); color:#fff; padding: 12px 14px;
      border-radius: 10px; font-family: Arial, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,.5);
      width: 260px; max-height: 420px; overflow-y:auto;
    }
    .referencias { display:flex; flex-direction:column; gap:8px; margin:0; }
    .referencia { display:flex; align-items:center; gap:10px; }
    .color-box { width: 18px; height: 18px; border: 1px solid #000; }
    .azul { background: rgb(9,0,128); }
    .verde { background: green; }
    .amarillo { background: yellow; }
    .naranja { background: #FFA500; }
    .darkorange { background: #FF8C00; }
    .rojo { background: #ff0000; }
    .maroon { background: #720303; }
    .peru { background: #2b0101; }
    .black { background: #160000; }
    @media (max-width: 768px) { #referencias { display:none; } }

    /* Modal simple */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; z-index: 2000; }
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #fff; color:#111; border-radius: 12px; width: 92%; max-width: 520px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25); display: none; z-index: 2001;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .modal header { padding:14px 16px; border-bottom:1px solid #efefef; font-weight:600; }
    .modal .content { padding:12px 16px; display:grid; gap:10px; }
    .modal .row { display:grid; gap:6px; }
    .modal input, .modal textarea, .modal select {
      width:100%; border:1px solid #ccc; border-radius:8px; padding:8px 10px; font-size:14px;
    }
    .modal footer { display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid #efefef; }
    .btn { background:#111; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.secondary { background:#e0e0e0; color:#111; }
  </style>

<style>
  /* ===== Busy overlay (loading gif/spinner) ===== */
  #busy-overlay{
    position: fixed;
    inset: 0;
    z-index: 4500;
    background: rgba(0,0,0,.45);
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(1.5px);
  }
  #busy-overlay .busy-card{
    background: rgba(15,23,42,.92);
    color: #e5e7eb;
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 18px 20px;
    display:flex;
    gap:12px;
    align-items:center;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
    font: 600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  #busy-overlay .spinner{
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,.25);
    border-top-color: rgba(255,255,255,.95);
    animation: spin 0.9s linear infinite;
  }
</style>

</head>


<body>

<!-- Botón flotante para mostrar/ocultar referencias en mobile -->
<button id="btnReferencias" class="refs-toggle" aria-controls="referencias" aria-expanded="false" type="button">
  Referencias
</button>



<div id="auth-bar">
  <span id="auth-info" class="pill auth-hidden"></span>
  <button id="btnAuthOpen" type="button">Acceder</button>
  <button id="btnLogout" class="auth-hidden" type="button">Salir</button>
  <button id="btnRefresh" type="button" title="Refrescar datos" aria-label="Refrescar datos">↻</button>
</div>


  <div id="map"></div>

  <div id="referencias">
    <h3 style="margin:0 0 8px 0">Referencias</h3>
    <div class="referencias">
      <div class="referencia"><div class="color-box azul"></div><span>Se está trabajando</span></div>
      <div class="referencia"><div class="color-box verde"></div><span>Se realizó 1 vez</span></div>
      <div class="referencia"><div class="color-box amarillo"></div><span>Se realizó 2 veces</span></div>
      <div class="referencia"><div class="color-box naranja"></div><span>Se realizó 3 veces</span></div>
      <div class="referencia"><div class="color-box darkorange"></div><span>Se realizó 4 veces</span></div>
      <div class="referencia"><div class="color-box rojo"></div><span>Se realizó 5 veces</span></div>
      <div class="referencia"><div class="color-box maroon"></div><span>Se realizó 6 veces</span></div>
      <div class="referencia"><div class="color-box peru"></div><span>Se realizó 7 veces</span></div>
      <div class="referencia"><div class="color-box black"></div><span>Se realizó 8+ veces</span></div>
    </div>
  </div>

  <!-- Modal de registro -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <header><span id="modal-title">Registrar territorio</span></header>
    <div class="content">
      <div class="row">
        <label for="campoTerritorio">Territorio</label>
        <input id="campoTerritorio" type="text" readonly />
      </div>
      <div class="row">
        <label for="campoPoligono">Manzana</label>
        <input id="campoPoligono" type="text" readonly />
      </div>
      <div class="row">
        <label for="campoCapitan">Capitán</label>
        <input id="campoCapitan" type="text" readonly />
      </div>
      <div class="row">
        <label for="campoFecha">Fecha</label>
        <input id="campoFecha" type="date" />
      </div>
      <div class="row">
        <label for="campoEstado">¿Finalizó?</label>
        <select id="campoEstado">
          <option value="Si">Si</option>
          <option value="No">No</option>
        </select>
      </div>
      <div class="row">
        <label for="campoNotas">Comentario</label>
        <textarea id="campoNotas" rows="3" placeholder="Observaciones opcionales"></textarea>
      </div>
    </div>
    <footer>
      <button class="btn secondary" id="btnCancelar">Cancelar</button>
      <button class="btn" id="btnGuardar">Guardar registro</button>
    </footer>
  </div>

  
  <script>
    // Lista editable de capitanes (podés cambiar estos nombres cuando quieras)
    const CAPITANES = [
      "Christian Mermot","Esteban Longo","Oscar Alcalde","Sebastian Barbiel","Juan Toyos",
      "Leonardo De Los Santos","Pablo Andrade","Gilberto Andrade","Richard Guzmán","Federico Callorda",
      "Nicolás Rodriguez","Ernesto dos Santos","Santiago Varaldo","Guillermo Lobato","Rubén Álvarez"];
    function renderCapitanes() {
      const dl = document.getElementById("listaCapitanes");
      if (!dl) return;
      dl.innerHTML = "";
      for (const nombre of CAPITANES) {
        const opt = document.createElement("option");
        opt.value = nombre;
        dl.appendChild(opt);
      }
    }
    document.addEventListener("DOMContentLoaded", renderCapitanes);
  </script>

  <script src="poligonos_salinas.js"></script>

  <script>
    // ===== Helpers de ID =====
    window.normalizarId = window.normalizarId || function normalizarId(x) {
      let s = String(x ?? '')
          .trim()
          .replace(/\s*\|\s*/g, '|')
          .replace(/\s*-\s*/g, '-')   // si en backend comentaste esto, comentala acá también
          .replace(/\s+/g, ' ');
      if (!s) return "";
      const stripZeros = (v) => v.replace(/^0+/, "") || "0";
      if (/^\d+$/.test(s)) return stripZeros(s);
      let m = s.match(/(\d+)\s*$/);
      if (m) return stripZeros(m[1]);
      if (s.includes("|")) {
        const right = s.split("|").pop();
        m = right.match(/(\d+)(?!.*\d)/);
        if (m) return stripZeros(m[1]);
      }
      const all = s.match(/\d+/g);
      if (all && all.length) return stripZeros(all[all.length - 1]);
      return s;
    };
    window.idKey = window.idKey || function idKey(x){ return window.normalizarId(x); };

    function canonId(x) {
      return String(x ?? '')
        .trim()
        .replace(/\s*\|\s*/g, '|')
        .replace(/\s*-\s*/g, '-')   // si en backend comentaste esto, comentala acá también
        .replace(/\s+/g, ' ');
    }

    function idKey(x) {
      return canonId(x); // la key ES el ID canónico completo (no solo números)
    }
    // ===== Centroide por área (definir ANTES de usar) =====
    function centroidArea(coords) {
      // coords: [[lat,lng], ...]
      if (!Array.isArray(coords) || coords.length < 3) return null;
      // Convertimos a (x=lng, y=lat) para fórmula planar
      const pts = coords.map(c => [c[1], c[0]]);
      const n = pts.length;
      let area = 0, cx = 0, cy = 0;
      for (let i=0; i<n; i++) {
        const [x0,y0] = pts[i];
        const [x1,y1] = pts[(i+1)%n];
        const a = x0*y1 - x1*y0;
        area += a;
        cx += (x0 + x1) * a;
        cy += (y0 + y1) * a;
      }
      area *= 0.5;
      if (Math.abs(area) < 1e-12) return null;
      cx /= (6*area); cy /= (6*area);
      return [cy, cx]; // [lat,lng]
    }

    // ===== Vistas =====
    const centrosPorVista = {
      0: [-34.81, -55.93],
1: [-34.81336542548195, -55.94933026500102],
      2: [-34.82008935931963, -55.93356006777914],
      3: [-34.81338539561594, -55.932902226529094],
      4: [-34.81235461487246, -55.920060714757625],
      5: [-34.80399990239286, -55.916780479198835],
      6: [-34.80905521388421, -55.916027280722815],
      7: [-34.80517799529366, -55.90668192039635],
    };
    const territoriosPorVista = {
      1: [1,2,3],
      2: [4,6,8],
      3: [5,7,9],
      4: [10,11,12],
      5: [13,14,15],
      6: [13,14,15,10,11,12],
      7: [16,17,18,19,20,21,22],
    };
    function getVistaFromURL() {
      const p = new URLSearchParams(location.search);
      const n = parseInt(p.get('vista'), 10);
      return (n >= 0 && n <= 7) ? n : 1;
    }
    function toNumeroTerritorio(t) {
      const s = window.idKey ? window.idKey(t) : String(t ?? "").trim();
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? n : null;
    }
    function centroide(coords) {
      // centroide "spherical" aproximado (fallback)
      let x=0, y=0, z=0, n=coords.length;
      for (const c of coords) {
        const lat = c[0] * Math.PI/180;
        const lon = c[1] * Math.PI/180;
        x += Math.cos(lat) * Math.cos(lon);
        y += Math.cos(lat) * Math.sin(lon);
        z += Math.sin(lat);
      }
      x/=n; y/=n; z/=n;
      const lon = Math.atan2(y, x);
      const hyp = Math.sqrt(x*x + y*y);
      const lat = Math.atan2(z, hyp);
      return [lat*180/Math.PI, lon*180/Math.PI];
    }

    // ===== Fuente de datos (JSON desde Apps Script, sin CSV) =====
// Usamos el MISMO WebApp que ya tenés para guardar (WEBHOOK_URL) pero con ?read=stats_rt
// Respuesta esperada: { ok:true, items:[{id:'...', cantidad:3, finalizado:'Si'} ...] }
// Soporta JSONP: ?read=stats_rt&callback=miFuncion
async function cargarDatosDesdeBackend() {
  const base = (typeof WEBHOOK_URL === 'string' && WEBHOOK_URL) ? WEBHOOK_URL : '';
  if (!base) return [];

  // stats_rt SIEMPRE por JSONP (evita CORS)
  const url = base + (base.includes('?') ? '&' : '?') + 'read=stats_rt';
  return await cargarDatosJSONP(url);
}


function cargarDatosJSONP(urlBase) {
  return new Promise((resolve) => {
    const cb = '__cbStats_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');

    const cleanup = () => {
      try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
    };

    window[cb] = (payload) => {
      cleanup();
      try{
        const items = (payload && Array.isArray(payload.items)) ? payload.items : [];
        resolve(items);
      }catch(_){
        resolve([]);
      }
    };

    const sep = urlBase.includes('?') ? '&' : '?';
    s.src = urlBase + sep + 'callback=' + encodeURIComponent(cb);
    s.async = true;
    s.onerror = () => { cleanup(); resolve([]); };
    document.head.appendChild(s);
  });
}


    // ===== Modal / envío =====
    const $modal = document.getElementById('modal');
    const $backdrop = document.getElementById('backdrop');
    const $campoTerritorio = document.getElementById('campoTerritorio');
    const $campoPoligono = document.getElementById('campoPoligono');
    const $campoCapitan = document.getElementById('campoCapitan');
    const $campoFecha = document.getElementById('campoFecha');
    const $campoEstado = document.getElementById('campoEstado');
    const $campoNotas = document.getElementById('campoNotas');
    const $btnCancelar = document.getElementById('btnCancelar');
    const $btnGuardar = document.getElementById('btnGuardar');
    function abrirModal(terr, polyId) {$campoTerritorio.value = terr;
      $campoPoligono.value   = polyId;
      $campoCapitan.value    = (window.AuthApp && AuthApp.getUsername && AuthApp.getUsername()) || '';
      $campoFecha.value      = new Date().toISOString().slice(0,10);
      $campoEstado.value     = 'Si';
      $campoNotas.value      = '';
      $backdrop.style.display = 'block';
      $modal.style.display    = 'block';
    }
    function cerrarModal(){ $modal.style.display='none'; $backdrop.style.display='none'; }
    $btnCancelar.addEventListener('click', cerrarModal);
    $backdrop.addEventListener('click', (e)=>{ if(e.target===$backdrop) cerrarModal(); });
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbw5wH4kYsZ_Mo92ytaWJo5nyquLPE95htPVE_vNxxCeGflejrus_-iBcwvmQvxTHkE/exec";

function showBusy(msg){
  const ov = document.getElementById('busy-overlay');
  const tx = document.getElementById('busy-text');
  if (tx) tx.textContent = msg || 'Procesando…';
  if (ov) ov.style.display = 'flex';
}
function hideBusy(){
  const ov = document.getElementById('busy-overlay');
  if (ov) ov.style.display = 'none';
}

async function enviarAlSheet(rec) {
  if (!WEBHOOK_URL) {
    console.log("Registro simulado:", rec);
    return { ok: true, simulated: true, territorio: String(rec.id || rec.territorio || ''), cantidad: null };
  }

  const payloadStr = JSON.stringify(rec);

  // helper: JSONP
  function fetchJsonp(url, cbParam = "callback", timeoutMs = 12000) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const sep = url.includes("?") ? "&" : "?";
      const full = url + sep + new URLSearchParams({ [cbParam]: cbName });

      let done = false;
      const t = setTimeout(() => {
        if (done) return;
        done = true;
        try { delete window[cbName]; } catch (_) {}
        script.remove();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      window[cbName] = (data) => {
        if (done) return;
        done = true;
        clearTimeout(t);
        try { delete window[cbName]; } catch (_) {}
        script.remove();
        resolve(data);
      };

      const script = document.createElement("script");
      script.src = full;
      script.onerror = () => {
        if (done) return;
        done = true;
        clearTimeout(t);
        try { delete window[cbName]; } catch (_) {}
        script.remove();
        reject(new Error("JSONP error"));
      };
      document.head.appendChild(script);
    });
  }

  try {
    // 1) POST (preferido)
    const body = new URLSearchParams({ payload: payloadStr });
    const r = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
      body
    });

    // Si el navegador bloqueó CORS, r.ok puede ser false o incluso lanzar excepción arriba.
    // Pero si llegó y es OK, leemos JSON:
    if (r.ok) {
      const data = await r.json().catch(() => ({}));
      // data esperado: { ok:true, territorio, cantidad }
      return { ...data, via: "POST" };
    }

    // 2) GET normal (intentamos leer JSON)
    const urlGet = WEBHOOK_URL + "?" + new URLSearchParams({ payload: payloadStr });
    const r2 = await fetch(urlGet, { method: "GET" });
    if (r2.ok) {
      const data2 = await r2.json().catch(() => ({}));
      return { ...data2, via: "GET" };
    }

    // 3) JSONP final (si CORS molesta)
    const urlJsonp = WEBHOOK_URL + "?" + new URLSearchParams({ payload: payloadStr });
    const data3 = await fetchJsonp(urlJsonp);
    return { ...data3, via: "JSONP" };

  } catch (e) {
    // 3b) si tiró excepción (probable CORS), probamos JSONP
    try {
      const urlJsonp = WEBHOOK_URL + "?" + new URLSearchParams({ payload: payloadStr });
      const data3 = await fetchJsonp(urlJsonp);
      return { ...data3, via: "JSONP" };
    } catch (e2) {
      return { ok: false, reason: String(e2 || e) };
    }
  }
}

    $btnGuardar.addEventListener('click', async () => {
  const territorio = $campoTerritorio.value;
  const poligonoId = $campoPoligono.value;
  const capitan    = $campoCapitan.value.trim();
  const fecha      = $campoFecha.value;
  const finalizado = $campoEstado.value;
  const comentario = $campoNotas.value.trim();
  const sincronizado = "";

  // IMPORTANTE: id = territorio (para conteo por territorio)
  const comentarioFinal = (comentario ? comentario : '') + (poligonoId ? (' | Manzana: ' + poligonoId) : '');
  const rec = { id: poligonoId, territorio, poligonoId, fecha, finalizado, capitan, comentario: comentarioFinal, sincronizado };

  try{
    $btnGuardar.disabled = true;
    showBusy('Guardando…');

    const r = await enviarAlSheet(rec);
    if (r.ok) {
      const key = String(r.id || poligonoId).trim();
      __datosMap.set(key, { id: key, cantidad: Number(r.cantidad || 0) });

      // repintar esa manzana puntual (si tenés layer guardado), o repintar todo:
      await init();
    }

    // ✅ Actualizar conteo local y repintar SOLO ese territorio
    const terKey = idKey(r.territorio || territorio);
    const cant   = Number(r.cantidad || 0);
    window.__datosMap = window.__datosMap || new Map();
    window.__datosMap.set(terKey, { id: terKey, cantidad: cant, finalizado: finalizado });

    if (typeof repintarTerritorio === 'function'){
      repintarTerritorio(territorio);
    } else {
      // fallback: repintar todo
      await init();
    }

    cerrarModal();
    (window.showToast || console.log)('Registro guardado. Total del territorio: ' + cant);
  }catch(e){
    console.error(e);
    alert(String(e.message || e));
  }finally{
    hideBusy();
    $btnGuardar.disabled = false;
  }
});

    // ===== Mapa =====
    const vista = getVistaFromURL();
    const map = L.map('map', { zoomControl: true }).setView(centrosPorVista[vista], 19);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {  attribution: '&copy; OpenStreetMap contributors' , maxZoom: 19 }).addTo(map);

    const polygonsLayer = L.featureGroup().addTo(map);
    const cartelesLayer = L.featureGroup().addTo(map);
const labelsLayer   = L.featureGroup().addTo(map);

    function indexarPorTerritorio(arr) {
      const mapa = new Map();
      for (const p of (arr||[])) {
        if (!Array.isArray(p.coords) || !p.coords.length) continue;
        const terrNum = toNumeroTerritorio(p.territorio);
        if (!terrNum) continue;
        if (!mapa.has(terrNum)) mapa.set(terrNum, []);
        mapa.get(terrNum).push(p);
      }
      return mapa;
    }

    function getFillHexFromDatos(id) {
      const key = idKey(id);
      const d = __datosMap.get(key);

      if (d) {
        const claseAHex = {
          gray:'#808080', blue:'rgb(9,0,128)', green:'green', yellow:'yellow', orange:'#FFA500', darkorange:'#FF8C00',
          red:'#ff0000', maroon:'#720303', peru:'#2b0101', black:'#160000'
        };
        console.log(id + " : " + d.cantidad);
        const c = obtenerColor(d.cantidad);
        return claseAHex[c] || '#000';
      }else{
        return '#808080';
      }
    }

  function obtenerColor(cantidad) {
  cantidad = Number(cantidad) || 0;

      if (cantidad === 0) return "gray";
      if (cantidad === 1) return "green";
      if (cantidad === 2) return "yellow";
      if (cantidad === 3) return "orange";
      if (cantidad === 4) return "darkorange";
      if (cantidad === 5) return "red";
      if (cantidad === 6) return "maroon";
      if (cantidad === 7) return "peru";
      if (cantidad >= 8) return "black";
      return "gray";                         // azul muy fuerte
}


function repintarTerritorio(territorio){
  const terrKey = window.idKey ? window.idKey(territorio) : String(territorio ?? '');
  polygonsLayer.eachLayer(layer => {
    // layer carries no terr prop; we reconstruct from closure? Instead read from stored options if attached.
    // We'll attach __terr on creation below; if not, fallback via feature props.
    const t = layer && layer.__terr != null ? layer.__terr : null;
    if (String(t) === String(territorio)) {
      const hex = getFillHexFromDatos(layer.__polyId);
      layer.setStyle({ fillColor: hex });
    }
  });
}


async function init() {
  if (!Array.isArray(window.poligonos) || !window.poligonos.length) {
    alert('poligonos_salinas.js no definió window.poligonos o está vacío'); return;
  }
  const byTerr = indexarPorTerritorio(window.poligonos);

  // Datos JSON (stats_rt)
  const datos = await cargarDatosDesdeBackend();
  // Normalizamos las claves para asegurar match con p.id
  window.__datosMap = new Map(datos.map(d => [window.idKey ? window.idKey(d.id) : String(d.id), d]));

  // Pintar
  const territorios = territoriosPorVista[vista] || [];
  polygonsLayer.clearLayers(); labelsLayer.clearLayers(); cartelesLayer.clearLayers();
  let bounds = null;

  if (vista === 0) {
    // Show ALL polygons (no territory filtering)
    const listaAll = Array.isArray(window.poligonos) ? window.poligonos : [];
    for (const p of listaAll) {
      const hex = getFillHexFromDatos(p.id);
      const poly = L.polygon(p.coords, { color:'#000', weight:1, fillColor:hex, fillOpacity:0.5 }).addTo(polygonsLayer);
      poly.__terr = (typeof terr !== 'undefined' ? terr : p.territorio);
      poly.__polyId = p.id;
      poly.on('click', () => abrirModalSiLogueado(p.territorio, p.id));
      const labelPt = centroidArea(p.coords) || centroide(p.coords) || poly.getBounds().getCenter();
      const icon = L.divIcon({ className:'numero-cartel', html:String(p.id), iconSize: null, iconAnchor: [0,0] });
      L.marker(labelPt, { icon, interactive:false, zIndexOffset: 1000 }).addTo(labelsLayer);
      if (!bounds) bounds = L.latLngBounds(p.coords); else bounds.extend(p.coords);
    }
    // Mostrar carteles fijos de todos los territorios
    renderCarteles(Array.from(coordsByTerr.keys()));
  } else {
    for (const terr of territorios) {
      const lista = byTerr.get(terr) || [];
      for (const p of lista) {
        const hex = getFillHexFromDatos(p.id);
        const poly = L.polygon(p.coords, { color:'#000', weight:1, fillColor:hex, fillOpacity:0.5 }).addTo(polygonsLayer);
      poly.__terr = (typeof terr !== 'undefined' ? terr : p.territorio);
      poly.__polyId = p.id;
        poly.on('click', () => abrirModalSiLogueado(terr, p.id));
        // Label: centroide por área -> centroide geom. -> bounds center
        const labelPt = centroidArea(p.coords) || centroide(p.coords) || poly.getBounds().getCenter();
        const icon = L.divIcon({ className:'numero-cartel', html:String(p.id), iconSize: null, iconAnchor: [0,0] });
        L.marker(labelPt, { icon, interactive:false, zIndexOffset: 1000 }).addTo(labelsLayer);
        if (!bounds) bounds = L.latLngBounds(p.coords); else bounds.extend(p.coords);
      }
    }
    // Carteles fijos para los territorios de la vista
    renderCarteles(territorios);
  }

  if (bounds && bounds.isValid()) {
    map.fitBounds(bounds, { padding: [10,10], maxZoom: 19 });
    const center = bounds.getCenter();
    map.setView(center, 19, { animate: false });
  } else {
    map.setView(centrosPorVista[vista], 19, { animate: false });
  }
}


init();

// ===== Botón "Refrescar datos" (recalcula cantidades y repinta polígonos) =====
(function(){
  const btn = document.getElementById('btnRefresh');
  if (!btn) return;

  async function refrescar(){
    try{
      btn.disabled = true;
      btn.classList.add('loading');
      showBusy('Refrescando…');
      await init(); // vuelve a pedir stats_rt y repinta
      (window.showToast || console.log)('Datos actualizados');
    }catch(e){
      console.error(e);
      (window.showToast || console.log)('No se pudieron refrescar los datos');
    }finally{
      btn.classList.remove('loading');
      btn.disabled = false;
      hideBusy();
    }
  }

  btn.addEventListener('click', refrescar);

  // TIP: Shift+R también refresca
  window.addEventListener('keydown', (ev) => {
    if ((ev.key === 'R' || ev.key === 'r') && ev.shiftKey) {
      ev.preventDefault();
      refrescar();
    }
  });
})();

</script>

  <script>
    // Evitar ingresar un Capitán que no esté en la lista
    document.addEventListener("DOMContentLoaded", () => {
      const inputCap = document.getElementById("campoCapitan");
      if (!inputCap) return;
      inputCap.addEventListener("change", () => {
        const val = inputCap.value.trim();
        const found = CAPITANES.some(n => n.toLowerCase() === val.toLowerCase());
        if (!found) {
          alert("Por favor, seleccioná un Capitán de la lista disponible.");
          inputCap.value = "";
        }
      });
    });
  </script>


  
  <script>
    // Coordenadas fijas para carteles por TERRITORIO (1..22)
    const coordsByTerr = new Map([
      [1,  [-34.81336542548195, -55.94933026500102]],
      [2,  [-34.811286582180394, -55.94544642620604]],
      [3,  [-34.81657188632685, -55.942062667848774]],
      [4,  [-34.82223477650662, -55.94038877194424]],
      [5,  [-34.81527508555718, -55.93809954150837]],
      [6,  [-34.82008935931963, -55.93356006777914]],
      [7,  [-34.81338539561594, -55.932902226529094]],
      [8,  [-34.81728165653415, -55.93010626853567]],
      [9,  [-34.81119372960812, -55.92738340680523]],
      [10, [-34.8153728400786,  -55.92574621955909]],
      [11, [-34.80692886323752, -55.923469040934265]],
      [12, [-34.81235461487246, -55.920060714757625]],
      [13, [-34.80905521388421, -55.916027280722815]],
      [14, [-34.80399990239286, -55.916780479198835]],
      [15, [-34.79955924683334, -55.91118856321308]],
      [16, [-34.80960324530219, -55.91052636263731]],
      [17, [-34.80643158858064, -55.90936751162679]],
      [18, [-34.808515833887576,-55.90841099968181]],
      [19, [-34.80153793586342, -55.905798986293206]],
      [20, [-34.80700551639037, -55.904529768519666]],
      [21, [-34.80517799529366, -55.90668192039635]],
      [22, [-34.804629251764304,-55.902662737758725]]
    ]);
  </script>

<script>
    function renderCarteles(territorios) {
      if (!Array.isArray(territorios)) return;
      territorios.forEach(t => {
        const ll = coordsByTerr.get(Number(t));
        if (!ll) return;
        const numeroIcon = L.divIcon({
          className: "numero-cartel-fijo",
          html: "&nbsp;" + String(t),
          iconSize: [35,35],
          iconAnchor: [15,15]
        });
        L.marker(ll, { icon: numeroIcon, interactive: false }).addTo(cartelesLayer);
      });
    }
  </script>


<!-- ===== LOGIN MODAL (idéntico a index.slim2.html en estructura/IDs) ===== -->
<div id="login-overlay" class="overlay">
  <div id="login-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <header class="modal-header">
      <h3 id="login-title" class="modal-title">Iniciar sesión</h3>
      <button id="login-close" class="modal-close-btn" title="Cerrar">✕</button>
    </header>
    <div class="modal-body">
      <div class="form-field">
        <label for="inUser" class="form-label">Usuario</label>
        <input id="inUser" class="form-input" autocomplete="username" />
      </div>
      <div class="form-field">
        <label for="inPass" class="form-label">Contraseña</label>
        <input id="inPass" class="form-input" type="password" autocomplete="current-password" />
      </div>
      <div class="form-actions">
        <button id="login-cancel" class="btn-cancel" type="button">Cancelar</button>
        <button id="btnLogin" class="btn-primary" type="button">Ingresar</button>
      </div>
    </div>
  </div>
</div>


<script>
// ===== Toast fallback (si no existe) =====
window.showToast = window.showToast || function(msg){
  if (!msg) return;
  try { console.log("[toast]", msg); } catch(_){}
};

// ====== DOM refs ======
const btnAuthOpen    = document.getElementById('btnAuthOpen');
const btnLogout      = document.getElementById('btnLogout');
const overlayLogin   = document.getElementById('login-overlay');
const btnLogin       = document.getElementById('btnLogin');
const inUser         = document.getElementById('inUser');
const inPass         = document.getElementById('inPass');
const btnCloseLogin  = document.getElementById('login-close');
const btnCancelLogin = document.getElementById('login-cancel');

function openLogin(){
  overlayLogin.style.display='flex';
  inUser && inUser.focus();
}
function closeLogin(){
  overlayLogin.style.display='none';
}

btnAuthOpen && btnAuthOpen.addEventListener('click', openLogin);
btnCloseLogin && btnCloseLogin.addEventListener('click', closeLogin);
btnCancelLogin && btnCancelLogin.addEventListener('click', closeLogin);

btnLogin && btnLogin.addEventListener('click', () => {
  const u = (inUser.value||'').trim();
  const p = (inPass.value||'').trim();
  if (!u || !p){
    window.showToast && window.showToast('Ingresá usuario y contraseña');
    return;
  }
  if (window.AuthApp && typeof window.AuthApp.doLogin === "function"){
    window.AuthApp.doLogin(u,p);
  } else {
    window.showToast && window.showToast('AuthApp no está disponible');
  }
  closeLogin();
});

btnLogout && btnLogout.addEventListener('click', () => {
  if (window.AuthApp && typeof window.AuthApp.logout === "function"){
    window.AuthApp.logout();
  }
});

// Restaurar sesión al cargar
document.addEventListener('DOMContentLoaded', () => {
  if (window.AuthApp && typeof window.AuthApp.restore === "function"){
    window.AuthApp.restore();
  }
});
</script>

<script>
// === Gate de registro: sólo mostrar modal si hay sesión ===
function __isLogged(){
  try{
    return !!(window.AuthApp && typeof AuthApp.isLogged === "function" && AuthApp.isLogged());
  }catch(_){ return false; }
}
function __openLoginIfNeeded(){
  try{
    const overlay = document.getElementById('login-overlay');
    if (overlay){ overlay.style.display = 'flex'; }
  }catch(_){}
}
function abrirModalSiLogueado(terr, polyId){
  if (!__isLogged()){
    (window.showToast||console.log)("Necesitás iniciar sesión para registrar territorios");
    __openLoginIfNeeded();
    return;
  }
  if (typeof abrirModal === "function"){
    abrirModal(terr, polyId);
  }
}
</script>


<script>
(function(){
  function setupReferenciasToggle(){
    var btn = document.getElementById('btnReferencias');
    var panel = document.getElementById('referencias');
    if (!btn || !panel) return;

    var mq = window.matchMedia('(max-width: 768px)');

    function collapse(){
      panel.style.overflow = 'hidden';
      panel.style.maxHeight = '0px';
      panel.style.opacity = '0';
      panel.dataset.collapsed = 'true';
      btn.setAttribute('aria-expanded','false');
    }
    function expand(){
      panel.style.overflow = 'hidden';
      panel.style.display = 'block';
      // Medimos el contenido y aplicamos altura
      var h = panel.scrollHeight;
      panel.style.maxHeight = h + 'px';
      panel.style.opacity = '1';
      panel.dataset.collapsed = 'false';
      btn.setAttribute('aria-expanded','true');
    }
    function resetDesktop(){
      panel.style.removeProperty('overflow');
      panel.style.removeProperty('max-height');
      panel.style.removeProperty('opacity');
      delete panel.dataset.collapsed;
      btn.setAttribute('aria-expanded','true');
    }
    function applyByViewport(){
      if (mq.matches){
        collapse();
        btn.style.display = 'inline-flex';
      } else {
        resetDesktop();
        btn.style.display = 'none';
      }
    }
    applyByViewport();
    mq.addEventListener('change', applyByViewport);

    btn.addEventListener('click', function(){
      if (panel.dataset.collapsed === 'true'){
        expand();
      } else {
        collapse();
      }
    });

    // Mantener altura correcta si cambia el viewport o el contenido
    window.addEventListener('resize', function(){
      if (panel.dataset.collapsed === 'false'){
        panel.style.maxHeight = panel.scrollHeight + 'px';
      }
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setupReferenciasToggle);
  } else {
    setupReferenciasToggle();
  }
})();
</script>


<script>
(function(){
  var ov = document.getElementById('login-overlay');
  var closeBtn = document.getElementById('login-close');
  var cancelBtn = document.getElementById('login-cancel');
  if (ov && closeBtn){ closeBtn.addEventListener('click', function(){ ov.style.display='none'; }); }
  if (ov && cancelBtn){ cancelBtn.addEventListener('click', function(){ ov.style.display='none'; }); }
})();
</script>


<!-- Busy overlay (se muestra al guardar/refrescar) -->
<div id="busy-overlay" role="status" aria-live="polite" aria-label="Procesando">
  <div class="busy-card">
    <div class="spinner" aria-hidden="true"></div>
    <div id="busy-text">Procesando…</div>
  </div>
</div>

</body>
</html>
