<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vistas Territorios – Coloreado por Veces (v4)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    /* Cartel del número de POLÍGONO (p.id) */
    
.numero-cartel {
  color: #ffffff;
  font-size: 10px;
  font-weight: bold;
  text-shadow: 0 0 6px rgba(0,0,0,0.6);
  background-color: rgba(205, 212, 221, 0.45); /* azul translúcido */
  padding: 8px 12px;
  border-radius: 10px;
  border: 2px solid rgba(255,255,255,0.4);
  pointer-events: none;
  user-select: none;
  transform: translate(-50%, -50%);
  line-height: 1;
  white-space: nowrap;
}

.numero-cartel-fijo {
  color: #fff;
  font-size: 20px;
  font-weight: bold;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
  background-color: rgba(0, 128, 255, 0.45); /* azul translúcido */
  padding: 3px 5px;
  border-radius: 5px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  pointer-events: none;
  user-select: none;
  transform: translate(-50%, -50%);
  line-height: 1;
}



    .modal input, .modal textarea, .modal select  {
      width: 90% !important;
    }

    /* Panel de referencias */
    #referencias {
      position: fixed; top: 10px; left: 10px; z-index: 1000;
      background: rgba(0,0,0,.8); color:#fff; padding: 12px 14px;
      border-radius: 10px; font-family: Arial, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,.5);
      width: 260px; max-height: 420px; overflow-y:auto;
    }
    .referencias { display:flex; flex-direction:column; gap:8px; margin:0; }
    .referencia { display:flex; align-items:center; gap:10px; }
    .color-box { width: 18px; height: 18px; border: 1px solid #000; }
    .azul { background: rgb(9,0,128); }
    .verde { background: green; }
    .amarillo { background: yellow; }
    .naranja { background: #FFA500; }
    .darkorange { background: #FF8C00; }
    .rojo { background: #ff0000; }
    .maroon { background: #720303; }
    .peru { background: #2b0101; }
    .black { background: #160000; }
    @media (max-width: 768px) { #referencias { display:none; } }

    /* Modal simple */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; z-index: 2000; }
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #fff; color:#111; border-radius: 12px; width: 92%; max-width: 520px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25); display: none; z-index: 2001;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .modal header { padding:14px 16px; border-bottom:1px solid #efefef; font-weight:600; }
    .modal .content { padding:12px 16px; display:grid; gap:10px; }
    .modal .row { display:grid; gap:6px; }
    .modal input, .modal textarea, .modal select {
      width:100%; border:1px solid #ccc; border-radius:8px; padding:8px 10px; font-size:14px;
    }
    .modal footer { display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid #efefef; }
    .btn { background:#111; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.secondary { background:#e0e0e0; color:#111; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="referencias">
    <h3 style="margin:0 0 8px 0">Referencias</h3>
    <div class="referencias">
      <div class="referencia"><div class="color-box azul"></div><span>Se está trabajando</span></div>
      <div class="referencia"><div class="color-box verde"></div><span>Se realizó 1 vez</span></div>
      <div class="referencia"><div class="color-box amarillo"></div><span>Se realizó 2 veces</span></div>
      <div class="referencia"><div class="color-box naranja"></div><span>Se realizó 3 veces</span></div>
      <div class="referencia"><div class="color-box darkorange"></div><span>Se realizó 4 veces</span></div>
      <div class="referencia"><div class="color-box rojo"></div><span>Se realizó 5 veces</span></div>
      <div class="referencia"><div class="color-box maroon"></div><span>Se realizó 6 veces</span></div>
      <div class="referencia"><div class="color-box peru"></div><span>Se realizó 7 veces</span></div>
      <div class="referencia"><div class="color-box black"></div><span>Se realizó 8+ veces</span></div>
    </div>
  </div>

  <!-- Modal de registro -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <header><span id="modal-title">Registrar territorio</span></header>
    <div class="content">
      <div class="row">
        <label for="campoTerritorio">Territorio</label>
        <input id="campoTerritorio" type="text" readonly />
      </div>
      <div class="row">
        <label for="campoPoligono">Manzana</label>
        <input id="campoPoligono" type="text" readonly />
      </div>
      <div class="row">
        <label for="campoCapitan">Capitán</label>
        <input id="campoCapitan" type="text" list="listaCapitanes" placeholder="Nombre del capitán"/>
        <datalist id="listaCapitanes"></datalist>
      </div>
      <div class="row">
        <label for="campoFecha">Fecha</label>
        <input id="campoFecha" type="date" />
      </div>
      <div class="row">
        <label for="campoEstado">¿Finalizó?</label>
        <select id="campoEstado">
          <option value="Si">Si</option>
          <option value="No">No</option>
        </select>
      </div>
      <div class="row">
        <label for="campoNotas">Comentario</label>
        <textarea id="campoNotas" rows="3" placeholder="Observaciones opcionales"></textarea>
      </div>
    </div>
    <footer>
      <button class="btn secondary" id="btnCancelar">Cancelar</button>
      <button class="btn" id="btnGuardar">Guardar registro</button>
    </footer>
  </div>

  
  <script>
    // Lista editable de capitanes (podés cambiar estos nombres cuando quieras)
    const CAPITANES = [
      "Christian Mermot","Esteban Longo","Oscar Alcalde","Sebastian Barbiel","Juan Toyos",
      "Leonardo De Los Santos","Pablo Andrade","Gilberto Andrade","Richard Guzmán","Federico Callorda",
      "Nicolás Rodriguez","Ernesto dos Santos","Santiago Varaldo"];
    function renderCapitanes() {
      const dl = document.getElementById("listaCapitanes");
      if (!dl) return;
      dl.innerHTML = "";
      for (const nombre of CAPITANES) {
        const opt = document.createElement("option");
        opt.value = nombre;
        dl.appendChild(opt);
      }
    }
    document.addEventListener("DOMContentLoaded", renderCapitanes);
  </script>

  <script src="poligonos_salinas.js"></script>

  <script>
    // ===== Helpers de ID =====
    window.normalizarId = window.normalizarId || function normalizarId(x) {
      let s = String(x ?? "")
        .normalize("NFKC")
        .replace(/[\u200B\u200C\u200D\u2060\uFEFF]/g, "")
        .replace(/[\u00A0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
      if (!s) return "";
      const stripZeros = (v) => v.replace(/^0+/, "") || "0";
      if (/^\d+$/.test(s)) return stripZeros(s);
      let m = s.match(/(\d+)\s*$/);
      if (m) return stripZeros(m[1]);
      if (s.includes("|")) {
        const right = s.split("|").pop();
        m = right.match(/(\d+)(?!.*\d)/);
        if (m) return stripZeros(m[1]);
      }
      const all = s.match(/\d+/g);
      if (all && all.length) return stripZeros(all[all.length - 1]);
      return s;
    };
    window.idKey = window.idKey || function idKey(x){ return window.normalizarId(x); };

    // ===== Centroide por área (definir ANTES de usar) =====
    function centroidArea(coords) {
      // coords: [[lat,lng], ...]
      if (!Array.isArray(coords) || coords.length < 3) return null;
      // Convertimos a (x=lng, y=lat) para fórmula planar
      const pts = coords.map(c => [c[1], c[0]]);
      const n = pts.length;
      let area = 0, cx = 0, cy = 0;
      for (let i=0; i<n; i++) {
        const [x0,y0] = pts[i];
        const [x1,y1] = pts[(i+1)%n];
        const a = x0*y1 - x1*y0;
        area += a;
        cx += (x0 + x1) * a;
        cy += (y0 + y1) * a;
      }
      area *= 0.5;
      if (Math.abs(area) < 1e-12) return null;
      cx /= (6*area); cy /= (6*area);
      return [cy, cx]; // [lat,lng]
    }

    // ===== Vistas =====
    const centrosPorVista = {
      0: [-34.81, -55.93],
1: [-34.81336542548195, -55.94933026500102],
      2: [-34.82008935931963, -55.93356006777914],
      3: [-34.81338539561594, -55.932902226529094],
      4: [-34.81235461487246, -55.920060714757625],
      5: [-34.80399990239286, -55.916780479198835],
      6: [-34.80905521388421, -55.916027280722815],
      7: [-34.80517799529366, -55.90668192039635],
    };
    const territoriosPorVista = {
      1: [1,2,3],
      2: [4,6,8],
      3: [5,7,9],
      4: [10,11,12],
      5: [13,14,15],
      6: [13,14,15,10,11,12],
      7: [16,17,18,19,20,21,22],
    };
    function getVistaFromURL() {
      const p = new URLSearchParams(location.search);
      const n = parseInt(p.get('vista'), 10);
      return (n >= 0 && n <= 7) ? n : 1;
    }
    function toNumeroTerritorio(t) {
      const s = window.idKey ? window.idKey(t) : String(t ?? "").trim();
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? n : null;
    }
    function centroide(coords) {
      // centroide "spherical" aproximado (fallback)
      let x=0, y=0, z=0, n=coords.length;
      for (const c of coords) {
        const lat = c[0] * Math.PI/180;
        const lon = c[1] * Math.PI/180;
        x += Math.cos(lat) * Math.cos(lon);
        y += Math.cos(lat) * Math.sin(lon);
        z += Math.sin(lat);
      }
      x/=n; y/=n; z/=n;
      const lon = Math.atan2(y, x);
      const hyp = Math.sqrt(x*x + y*y);
      const lat = Math.atan2(z, hyp);
      return [lat*180/Math.PI, lon*180/Math.PI];
    }

    // ===== CSV URL (misma del otro archivo) =====
    window.SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnjPtaFTh49d_U3mD8kNr6_YoXZoUL5d5Ah11E2FcAMjrHtSyJkH6Q6p0seJyp3JOa6iK2F8ODpxrf/pub?gid=1159469350&single=true&output=csv";

    // ===== CSV parsing + obtenerColor ====
    function parseCSVLine(line) {
      const out = []; let cur = "", inQ = false;
      for (let i=0;i<line.length;i++) {
        const ch = line[i];
        if (ch === '"') { if (inQ && line[i+1] === '"') { cur += '"'; i++; } else { inQ = !inQ; } }
        else if (ch === "," && !inQ) { out.push(cur); cur=""; }
        else { cur += ch; }
      }
      out.push(cur); return out;
    }
    function normalizarFinalizado(v) {
      const s = String(v ?? "").trim().toLowerCase();
      if (!s) return "";
      if (["si","sí","true","1","ok","finalizado","completo","terminado"].includes(s) || v === true) return "Si";
      if (["no","n","false","0","pendiente","incompleto"].includes(s)) return "No";
      return s;
    }
    function obtenerColor(cantidad, finalizado) {
      const fin = String(finalizado ?? "").trim().toLowerCase();
      const esSi = ["si","sí","true","1","ok","finalizado","completo","terminado"].includes(fin) || finalizado === true;
      if (cantidad === 0 && !esSi) return "gray";
      if (cantidad === 1 && !esSi) return "blue";
      if (cantidad === 1 &&  esSi) return "green";
      if (cantidad === 2) return "yellow";
      if (cantidad === 3) return "orange";
      if (cantidad === 4) return "darkorange";
      if (cantidad === 5) return "red";
      if (cantidad === 6) return "maroon";
      if (cantidad === 7) return "peru";
      if (cantidad >= 8) return "black";
      return "gray";
    }
    async function fetchTextWithFallback(sheetCsvUrl) {
      const res = await fetch(sheetCsvUrl, { headers: { Accept: "text/csv" } });
      if (!res.ok) throw new Error("No se pudo descargar el CSV ("+res.status+")");
      return res.text();
    }
    async function cargarDatosDesdeSheets() {
      try {
        const csvData = await fetchTextWithFallback(window.SHEET_CSV);
        const filas = csvData.split(/\r?\n/).filter(l => l.trim() !== "");
        if (!filas.length) return [];
        const header = parseCSVLine(filas[0]).map(h => String(h||"").toLowerCase().trim());
        let idxId = 0, idxCantidad = -1, idxFin = -1, start=0;
        const looksHeader = /(id|cantidad|veces|finalizado)/.test(header.join(","));
        if (looksHeader) {
          idxId = header.findIndex(x => x === "id" || x.includes("territorio"));
          if (idxId < 0) idxId = 0;
          idxCantidad = header.findIndex(x => x === "cantidad" || x.includes("veces"));
          idxFin = header.findIndex(x => x.includes("finalizado"));
          start = 1;
        }
        const out = [];
        for (let i=start;i<filas.length;i++) {
          const c = parseCSVLine(filas[i]); if (!c.length) continue;
          const id = window.idKey ? window.idKey(c[idxId]) : String(c[idxId]??"").trim();
          if (!id) continue;
          let cantidad = 0;
          if (idxCantidad >= 0) { const n = parseInt((c[idxCantidad]??"").trim(),10); if (Number.isFinite(n)) cantidad = n; }
          let finalizado = ""; if (idxFin >= 0) finalizado = normalizarFinalizado((c[idxFin]??"").trim());
          out.push({ id, cantidad, finalizado });
        }
        return out;
      } catch(e) { console.error(e); return []; }
    }

    // ===== Modal / envío =====
    const $modal = document.getElementById('modal');
    const $backdrop = document.getElementById('backdrop');
    const $campoTerritorio = document.getElementById('campoTerritorio');
    const $campoPoligono = document.getElementById('campoPoligono');
    const $campoCapitan = document.getElementById('campoCapitan');
    const $campoFecha = document.getElementById('campoFecha');
    const $campoEstado = document.getElementById('campoEstado');
    const $campoNotas = document.getElementById('campoNotas');
    const $btnCancelar = document.getElementById('btnCancelar');
    const $btnGuardar = document.getElementById('btnGuardar');
    function abrirModal(terr, polyId) {
      $campoTerritorio.value = terr;
      $campoPoligono.value   = polyId;
      $campoCapitan.value    = '';
      $campoFecha.value      = new Date().toISOString().slice(0,10);
      $campoEstado.value     = 'Si';
      $campoNotas.value      = '';
      $backdrop.style.display = 'block';
      $modal.style.display    = 'block';
    }
    function cerrarModal(){ $modal.style.display='none'; $backdrop.style.display='none'; }
    $btnCancelar.addEventListener('click', cerrarModal);
    $backdrop.addEventListener('click', (e)=>{ if(e.target===$backdrop) cerrarModal(); });
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbweVDu_2Vn0ygEMQdkgqbVprTKJ2kjAT--Wimo0cVTaASLK3-yJMkt175DJq-pky1Y/exec";
    async function enviarAlSheet(rec){
      if (!WEBHOOK_URL) { console.log("Registro simulado:", rec); return { ok:true, simulated:true }; }
      try {
        const body = new URLSearchParams({ payload: JSON.stringify(rec) });
        const r = await fetch(WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=utf-8'}, body });
        if (r.ok) return { ok:true, via:'POST' };
        const url = WEBHOOK_URL + '?' + new URLSearchParams({ payload: JSON.stringify(rec) });
        await fetch(url, { method:'GET', mode:'no-cors' });
        return { ok:true, via:'GET-no-cors' };
      } catch(e){ return { ok:false, reason:String(e) }; }
    }
    $btnGuardar.addEventListener('click', async () => {
      const territorio = $campoTerritorio.value;
      const poligonoId = $campoPoligono.value;
      const capitan    = $campoCapitan.value.trim();
      const fecha      = $campoFecha.value;
      const finalizado = $campoEstado.value;
      const comentario = $campoNotas.value.trim();
      const rec = { id: poligonoId, territorio, poligonoId, fecha, finalizado, capitan, comentario };
      const r = await enviarAlSheet(rec);
      if (r.ok) cerrarModal(); else alert("No se pudo guardar el registro");
    });

    // ===== Mapa =====
    const vista = getVistaFromURL();
    const map = L.map('map', { zoomControl: true }).setView(centrosPorVista[vista], 19);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {  attribution: '&copy; OpenStreetMap contributors' , maxZoom: 19 }).addTo(map);

    const polygonsLayer = L.featureGroup().addTo(map);
    const cartelesLayer = L.featureGroup().addTo(map);
const labelsLayer   = L.featureGroup().addTo(map);

    function indexarPorTerritorio(arr) {
      const mapa = new Map();
      for (const p of (arr||[])) {
        if (!Array.isArray(p.coords) || !p.coords.length) continue;
        const terrNum = toNumeroTerritorio(p.territorio);
        if (!terrNum) continue;
        if (!mapa.has(terrNum)) mapa.set(terrNum, []);
        mapa.get(terrNum).push(p);
      }
      return mapa;
    }

    function getFillHexFromDatos(id, terr) {
      const key = window.idKey ? window.idKey(id) : String(id ?? "");
      const d   = window.__datosMap && window.__datosMap.get(key);
      if (d) {
        const claseAHex = {
          gray:'#808080', blue:'rgb(9,0,128)', green:'green', yellow:'yellow', orange:'#FFA500', darkorange:'#FF8C00',
          red:'#ff0000', maroon:'#720303', peru:'#2b0101', black:'#160000'
        };
        const c = obtenerColor(d.cantidad, d.finalizado);
        return claseAHex[c] || '#000';
      }else{
        return '#808080';
      }
    }

    
async function init() {
  if (!Array.isArray(window.poligonos) || !window.poligonos.length) {
    alert('poligonos_salinas.js no definió window.poligonos o está vacío'); return;
  }
  const byTerr = indexarPorTerritorio(window.poligonos);

  // Datos CSV
  const datos = await cargarDatosDesdeSheets();
  // Normalizamos las claves para asegurar match con p.id
  window.__datosMap = new Map(datos.map(d => [window.idKey ? window.idKey(d.id) : String(d.id), d]));

  // Pintar
  const territorios = territoriosPorVista[vista] || [];
  polygonsLayer.clearLayers(); labelsLayer.clearLayers(); cartelesLayer.clearLayers();
  let bounds = null;

  if (vista === 0) {
    // Show ALL polygons (no territory filtering)
    const listaAll = Array.isArray(window.poligonos) ? window.poligonos : [];
    for (const p of listaAll) {
      const hex = getFillHexFromDatos(p.id, p.territorio);
      const poly = L.polygon(p.coords, { color:'#000', weight:1, fillColor:hex, fillOpacity:0.5 }).addTo(polygonsLayer);
      poly.on('click', () => abrirModal(p.territorio, p.id));
      const labelPt = centroidArea(p.coords) || centroide(p.coords) || poly.getBounds().getCenter();
      const icon = L.divIcon({ className:'numero-cartel', html:String(p.id), iconSize: null, iconAnchor: [0,0] });
      L.marker(labelPt, { icon, interactive:false, zIndexOffset: 1000 }).addTo(labelsLayer);
      if (!bounds) bounds = L.latLngBounds(p.coords); else bounds.extend(p.coords);
    }
    // Mostrar carteles fijos de todos los territorios
    renderCarteles(Array.from(coordsByTerr.keys()));
  } else {
    for (const terr of territorios) {
      const lista = byTerr.get(terr) || [];
      for (const p of lista) {
        const hex = getFillHexFromDatos(p.id, terr);
        const poly = L.polygon(p.coords, { color:'#000', weight:1, fillColor:hex, fillOpacity:0.5 }).addTo(polygonsLayer);
        poly.on('click', () => abrirModal(terr, p.id));
        // Label: centroide por área -> centroide geom. -> bounds center
        const labelPt = centroidArea(p.coords) || centroide(p.coords) || poly.getBounds().getCenter();
        const icon = L.divIcon({ className:'numero-cartel', html:String(p.id), iconSize: null, iconAnchor: [0,0] });
        L.marker(labelPt, { icon, interactive:false, zIndexOffset: 1000 }).addTo(labelsLayer);
        if (!bounds) bounds = L.latLngBounds(p.coords); else bounds.extend(p.coords);
      }
    }
    // Carteles fijos para los territorios de la vista
    renderCarteles(territorios);
  }

  if (bounds && bounds.isValid()) {
    map.fitBounds(bounds, { padding: [10,10], maxZoom: 19 });
    const center = bounds.getCenter();
    map.setView(center, 19, { animate: false });
  } else {
    map.setView(centrosPorVista[vista], 19, { animate: false });
  }
}

init();
</script>

  <script>
    // Evitar ingresar un Capitán que no esté en la lista
    document.addEventListener("DOMContentLoaded", () => {
      const inputCap = document.getElementById("campoCapitan");
      if (!inputCap) return;
      inputCap.addEventListener("change", () => {
        const val = inputCap.value.trim();
        const found = CAPITANES.some(n => n.toLowerCase() === val.toLowerCase());
        if (!found) {
          alert("Por favor, seleccioná un Capitán de la lista disponible.");
          inputCap.value = "";
        }
      });
    });
  </script>


  
  <script>
    // Coordenadas fijas para carteles por TERRITORIO (1..22)
    const coordsByTerr = new Map([
      [1,  [-34.81336542548195, -55.94933026500102]],
      [2,  [-34.811286582180394, -55.94544642620604]],
      [3,  [-34.81657188632685, -55.942062667848774]],
      [4,  [-34.82223477650662, -55.94038877194424]],
      [5,  [-34.81527508555718, -55.93809954150837]],
      [6,  [-34.82008935931963, -55.93356006777914]],
      [7,  [-34.81338539561594, -55.932902226529094]],
      [8,  [-34.81728165653415, -55.93010626853567]],
      [9,  [-34.81119372960812, -55.92738340680523]],
      [10, [-34.8153728400786,  -55.92574621955909]],
      [11, [-34.80692886323752, -55.923469040934265]],
      [12, [-34.81235461487246, -55.920060714757625]],
      [13, [-34.80905521388421, -55.916027280722815]],
      [14, [-34.80399990239286, -55.916780479198835]],
      [15, [-34.79955924683334, -55.91118856321308]],
      [16, [-34.80960324530219, -55.91052636263731]],
      [17, [-34.80643158858064, -55.90936751162679]],
      [18, [-34.808515833887576,-55.90841099968181]],
      [19, [-34.80153793586342, -55.905798986293206]],
      [20, [-34.80700551639037, -55.904529768519666]],
      [21, [-34.80517799529366, -55.90668192039635]],
      [22, [-34.804629251764304,-55.902662737758725]]
    ]);
  </script>

<script>
    function renderCarteles(territorios) {
      if (!Array.isArray(territorios)) return;
      territorios.forEach(t => {
        const ll = coordsByTerr.get(Number(t));
        if (!ll) return;
        const numeroIcon = L.divIcon({
          className: "numero-cartel-fijo",
          html: "&nbsp;" + String(t),
          iconSize: [35,35],
          iconAnchor: [15,15]
        });
        L.marker(ll, { icon: numeroIcon, interactive: false }).addTo(cartelesLayer);
      });
    }
  </script>

</body>
</html>
